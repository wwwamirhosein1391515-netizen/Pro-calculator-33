<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Vazirmatn', 'Tahoma', 'Segoe UI', 'sans-serif'],
                        mono: ['Tahoma', 'sans-serif'],
                        cursive: ['Brush Script MT', 'cursive'],
                    },
                    colors: {
                        glass: {
                            100: 'rgba(255, 255, 255, 0.1)',
                            200: 'rgba(255, 255, 255, 0.2)',
                            300: 'rgba(255, 255, 255, 0.3)',
                            border: 'rgba(255, 255, 255, 0.4)',
                        }
                    },
                    boxShadow: {
                        'glass': '0 4px 16px rgba(0,0,0,0.04)',
                        'glass-inset': 'inset 0 0 10px rgba(255, 255, 255, 0.15)',
                        'glow': '0 0 15px rgba(167, 139, 250, 0.3)',
                    },
                    animation: {
                        'float': 'float 6s ease-in-out infinite',
                        'blob': 'blob 7s infinite',
                        'fade-in-up': 'fadeInUp 1s ease-out forwards',
                        'rainbow': 'rainbow 5s linear infinite',
                        'spin-smooth': 'spin 1s linear',
                        'slide-in': 'slideIn 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        },
                        blob: {
                            '0%': { transform: 'translate(0px, 0px) scale(1)' },
                            '33%': { transform: 'translate(30px, -50px) scale(1.1)' },
                            '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
                            '100%': { transform: 'translate(0px, 0px) scale(1)' },
                        },
                        fadeInUp: {
                            '0%': { opacity: '0', transform: 'translateY(20px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        rainbow: {
                            '0%': { filter: 'hue-rotate(0deg)' },
                            '100%': { filter: 'hue-rotate(360deg)' }
                        },
                        slideIn: {
                            '0%': { opacity: '0', transform: 'scale(0.9)' },
                            '100%': { opacity: '1', transform: 'scale(1)' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* ========================================
           GENERAL BODY & BACKGROUND STYLES
           ======================================== */
        body {
            background: #FFFFFF;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow-x: hidden;
            font-family: 'Vazirmatn', 'Tahoma', sans-serif;
            transition: background 0.5s ease;
            padding-bottom: 120px;
        }

        body.dark-mode {
            background: linear-gradient(-45deg, #0f172a, #1e293b, #111827, #312e81);
            background-size: 400% 400%;
            color: #e2e8f0;
        }
        
        /* Dark mode glass panels */
        body.dark-mode .glass-panel {
            background: rgba(30, 41, 59, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.06);
            backdrop-filter: blur(20px);
        }
        
        /* Dark mode buttons */
        body.dark-mode .btn-bubble {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.12);
            color: #e2e8f0;
        }
        body.dark-mode .btn-bubble:hover {
            background: rgba(255, 255, 255, 0.15);
        }
        body.dark-mode .btn-op { background: rgba(245, 158, 11, 0.25); color: #fbbf24; }
        body.dark-mode .btn-eq { background: rgba(16, 185, 129, 0.25); color: #34d399; }
        body.dark-mode .btn-ac { background: rgba(244, 63, 94, 0.25); color: #fda4af; }
        body.dark-mode .btn-func { background: rgba(99, 102, 241, 0.15); color: #a5b4fc; }
        
        /* Dark mode inputs */
        body.dark-mode .glass-input {
            background: rgba(0, 0, 0, 0.25);
            border: 1px solid rgba(255, 255, 255, 0.08);
            color: #f8fafc;
        }
        
        /* Dark mode text colors */
        body.dark-mode .text-gray-800, 
        body.dark-mode .text-gray-700, 
        body.dark-mode .text-gray-600 {
            color: #e2e8f0;
        }
        
        /* Dark mode nav pills */
        body.dark-mode .nav-pill.active {
            background: rgba(255, 255, 255, 0.15);
            color: white;
        }
        
        /* Dark mode menu */
        body.dark-mode .menu-dropdown {
            background: rgba(30, 41, 59, 0.85);
            border: 1px solid rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(10px);
        }
        body.dark-mode .menu-item { color: #e2e8f0; }
        body.dark-mode .menu-item:hover { background: rgba(255, 255, 255, 0.08); }

        /* Easter egg animation */
        body.easter-egg-active {
            animation: rainbow 2s linear infinite !important;
        }

        /* ========================================
           GLASS PANEL & BUTTON STYLES - LIQUID GLASS DESIGN
           ======================================== */
        .glass-panel {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(30px) saturate(180%);
            -webkit-backdrop-filter: blur(30px) saturate(180%);
            border: 1.5px solid rgba(255, 255, 255, 0.9);
            box-shadow: 
                0 8px 32px rgba(31, 38, 135, 0.08),
                0 2px 8px rgba(31, 38, 135, 0.05),
                inset 0 1px 0 rgba(255, 255, 255, 0.6),
                0 1px 3px rgba(0, 0, 0, 0.02);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .btn-bubble {
            background: rgba(255, 255, 255, 0.6);
            border: 1.5px solid rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            position: relative;
            overflow: hidden;
            font-family: 'Tahoma', 'Vazirmatn', sans-serif;
            font-weight: 600;
            cursor: pointer;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1;
            box-shadow: 
                0 4px 12px rgba(0,0,0,0.06), 
                0 2px 4px rgba(0,0,0,0.04),
                inset 0 1px 0 rgba(255, 255, 255, 0.7);
        }

        .btn-bubble::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: radial-gradient(circle, rgba(255,255,255,0.5) 0%, rgba(255,255,255,0) 70%);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            opacity: 0;
            z-index: -1;
            pointer-events: none;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .btn-bubble:hover {
            background: rgba(255, 255, 255, 0.75);
            transform: translateY(-1px);
            box-shadow: 
                0 6px 16px rgba(0,0,0,0.08), 
                0 3px 6px rgba(0,0,0,0.05),
                inset 0 1px 0 rgba(255, 255, 255, 0.9);
        }

        .btn-bubble:hover::before {
            width: 100%;
            height: 100%;
            opacity: 1;
        }

        .btn-bubble:active {
            transform: scale(0.97);
            background: rgba(255, 255, 255, 0.85);
            box-shadow: 
                0 2px 8px rgba(0,0,0,0.08),
                inset 0 1px 2px rgba(0,0,0,0.05);
            transition: all 0.1s ease;
        }

        /* Button variants with liquid glass effect */
        .btn-op { 
            background: rgba(255, 243, 224, 0.7); 
            color: #d97706;
            border-color: rgba(251, 191, 36, 0.4);
        } 
        .btn-op:hover { 
            background: rgba(255, 243, 224, 0.85); 
            border-color: rgba(251, 191, 36, 0.6);
        }
        
        .btn-eq { 
            background: rgba(220, 252, 231, 0.7); 
            color: #059669;
            border-color: rgba(16, 185, 129, 0.4);
        }
        .btn-eq:hover { 
            background: rgba(220, 252, 231, 0.85); 
            border-color: rgba(16, 185, 129, 0.6);
        }
        
        .btn-ac { 
            background: rgba(254, 226, 226, 0.7); 
            color: #dc2626;
            border-color: rgba(239, 68, 68, 0.4);
        }
        .btn-ac:hover { 
            background: rgba(254, 226, 226, 0.85); 
            border-color: rgba(239, 68, 68, 0.6);
        }
        
        .btn-func { 
            background: rgba(238, 242, 255, 0.7); 
            color: #4f46e5;
            font-size: 1.1rem;
            border-color: rgba(129, 140, 248, 0.4);
        }
        .btn-func:hover { 
            background: rgba(238, 242, 255, 0.85); 
            border-color: rgba(129, 140, 248, 0.6);
        }

        /* ========================================
           INPUT & FORM STYLES
           ======================================== */
        .glass-input {
            background: rgba(255, 255, 255, 0.7);
            border: 1.5px solid rgba(229, 231, 235, 0.8);
            box-shadow: 
                inset 0 2px 4px rgba(0,0,0,0.03),
                0 1px 2px rgba(0,0,0,0.02);
            color: #1f2937;
            transition: all 0.3s;
            font-family: 'Tahoma', sans-serif;
            backdrop-filter: blur(10px);
        }
        .glass-input:focus {
            background: rgba(255, 255, 255, 0.85);
            border-color: rgba(156, 163, 175, 0.8);
            outline: none;
            box-shadow: 
                0 0 0 3px rgba(59, 130, 246, 0.1),
                inset 0 2px 4px rgba(0,0,0,0.03);
        }

        /* ========================================
           SCROLLBAR STYLES
           ======================================== */
        ::-webkit-scrollbar { width: 0px; background: transparent; }

        /* ========================================
           NAVIGATION PILLS
           ======================================== */
        .nav-pill {
            position: relative;
            z-index: 10;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .nav-pill.active {
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 
                0 4px 12px rgba(0, 0, 0, 0.08),
                0 2px 4px rgba(0, 0, 0, 0.04),
                inset 0 1px 0 rgba(255, 255, 255, 1);
            color: #111;
            font-weight: 700;
        }

        /* ========================================
           RESULT GRID LAYOUT
           ======================================== */
        .result-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        .result-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0.75rem;
            border-radius: 1rem;
            background: rgba(255, 255, 255, 0.6);
            border: 1.5px solid rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(15px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }
        body.dark-mode .result-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        /* ========================================
           MENU BUTTON & DROPDOWN
           ======================================== */
        .glass-menu-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px);
            border: 1.5px solid rgba(255, 255, 255, 0.95);
            box-shadow: 
                0 4px 16px rgba(0, 0, 0, 0.08),
                0 2px 4px rgba(0, 0, 0, 0.04),
                inset 0 1px 0 rgba(255, 255, 255, 1);
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            gap: 4px;
            cursor: pointer;
            z-index: 100;
            transition: all 0.3s ease;
        }
        .glass-menu-btn:hover {
            transform: scale(1.05);
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 
                0 6px 20px rgba(0, 0, 0, 0.1),
                0 3px 6px rgba(0, 0, 0, 0.05);
        }
        .dot {
            width: 5px;
            height: 5px;
            background-color: #333;
            border-radius: 50%;
        }

        .menu-dropdown {
            position: fixed;
            top: 80px;
            left: 20px;
            width: 220px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(25px);
            border: 1.5px solid rgba(255, 255, 255, 1);
            border-radius: 20px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            box-shadow: 
                0 8px 32px rgba(0,0,0,0.12),
                0 4px 8px rgba(0,0,0,0.06);
            opacity: 0;
            visibility: hidden;
            transform: translateY(-20px);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 99;
        }
        .menu-dropdown.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        .menu-item {
            padding: 12px 16px;
            border-radius: 12px;
            cursor: pointer;
            color: #333;
            font-weight: 600;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .menu-item:hover {
            background: rgba(59, 130, 246, 0.1);
            transform: translateX(-2px);
        }

        /* ========================================
           MODAL OVERLAY & CONTENT
           ======================================== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.15);
            backdrop-filter: blur(5px);
            z-index: 200;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }
        .modal-overlay.open {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            width: 90%;
            max-width: 400px;
            min-height: 400px;
            max-height: 80vh;
            overflow-y: auto;
            transform: scale(0.9);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .modal-overlay.open .modal-content {
            transform: scale(1);
        }

        /* ========================================
           TOAST NOTIFICATION
           ======================================== */
        #toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(10px);
            color: white;
            padding: 12px 24px;
            border-radius: 30px;
            z-index: 300;
            transition: transform 0.3s ease;
            box-shadow: 0 4px 16px rgba(0,0,0,0.3);
        }
        #toast.show {
            transform: translateX(-50%) translateY(0);
        }

        /* ========================================
           LOADING SPINNER
           ======================================== */
        #loading-spinner {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #FFFFFF;
            z-index: 20000;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: opacity 0.5s ease;
        }

        .spinner-ring {
            width: 80px;
            height: 80px;
            border: 8px solid rgba(0,0,0,0.1);
            border-top: 8px solid #3b82f6;
            border-radius: 50%;
            animation: spin-smooth 1s linear infinite;
        }

        /* ========================================
           INTRO OVERLAY - IMPROVED FOR MOBILE
           ======================================== */
        #intro-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #FFFFFF;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            transition: opacity 1.5s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 0;
            pointer-events: none;
        }

        #intro-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        .intro-text-style {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            font-weight: 700;
            color: #1a1a1a;
            letter-spacing: -0.5px;
            opacity: 0;
            transform: translateY(30px);
            transition: all 1.8s cubic-bezier(0.22, 1, 0.36, 1); 
            text-shadow: 0 2px 8px rgba(0,0,0,0.04);
            text-align: center;
        }

        #intro-hello {
            font-size: clamp(3rem, 12vw, 5rem);
            margin-bottom: 0.5rem;
        }
        #intro-sub {
            font-family: 'Vazirmatn', sans-serif;
            font-size: clamp(1rem, 4vw, 1.5rem);
            font-weight: 500;
            color: #444;
            transition-delay: 0.3s;
        }
        #intro-special-msg {
            font-family: 'Vazirmatn', sans-serif;
            font-size: clamp(1rem, 4vw, 1.5rem);
            font-weight: 700;
            color: #1f2937;
            text-align: center;
            padding: 0 20px;
            margin-bottom: 20px;
            line-height: 1.8;
            max-width: 90%;
        }
        #intro-welcome {
            font-size: clamp(1.5rem, 6vw, 2.5rem);
            margin-top: 2rem;
        }

        /* ========================================
           LOGIN OVERLAY
           ======================================== */
        #login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #FFFFFF;
            z-index: 10000;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: opacity 1s ease;
            padding: 20px;
        }

        #login-overlay .glass-input {
            color: #000 !important; 
            border-color: rgba(0,0,0,0.15) !important;
            background: rgba(255,255,255,0.7) !important;
        }
        #login-overlay .glass-input::placeholder {
            color: #666 !important;
        }
        #login-overlay h2 {
            color: #000 !important;
        }

        /* ========================================
           APP CONTAINER ANIMATION
           ======================================== */
        .app-container {
            opacity: 0;
            transition: opacity 1s ease-in;
        }
        .app-visible {
            opacity: 1;
        }

        /* ========================================
           USER NAME BADGE
           ======================================== */
        #user-name-badge {
            position: absolute;
            top: 5px;
            right: 15px;
            font-size: 0.85rem;
            font-weight: 700;
            color: #4b5563;
            padding: 8px 16px;
            border-radius: 9999px;
            background: rgba(255, 255, 255, 0.85);
            border: 1.5px solid rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(15px);
            z-index: 50;
            box-shadow: 
                0 3px 8px rgba(0, 0, 0, 0.08),
                inset 0 1px 0 rgba(255, 255, 255, 1);
        }
        body.dark-mode #user-name-badge {
            color: #e2e8f0;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        /* ========================================
           BLACKBOARD STYLES
           ======================================== */
        #blackboard-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a1a1a 0%, #0d0d0d 100%);
            z-index: 250;
            display: none;
            flex-direction: column;
            opacity: 0;
            transition: opacity 0.8s cubic-bezier(0.16, 1, 0.3, 1);
        }

        #blackboard-overlay.active {
            display: flex;
            opacity: 1;
        }

        #blackboard-canvas-container {
            flex: 1;
            position: relative;
            padding: 80px 20px 20px 20px;
            background: #1a1a1a;
            box-shadow: inset 0 0 40px rgba(0,0,0,0.8);
        }

        #blackboard-border {
            width: 100%;
            height: 100%;
            background: #0a0a0a;
            border: 25px solid;
            border-image: linear-gradient(135deg, #4a3020, #6b4423, #4a3020) 1;
            box-shadow: 
                0 0 0 5px #2a1810,
                inset 0 0 60px rgba(0,0,0,0.9),
                0 20px 50px rgba(0,0,0,0.6);
            border-radius: 8px;
            position: relative;
            overflow: hidden;
        }

        #blackboard-canvas {
            width: 100%;
            height: 100%;
            touch-action: none;
            cursor: crosshair;
            background: #0a0a0a;
        }

        .blackboard-back-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 55px;
            height: 55px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.12);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.25);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 270;
            font-size: 1.8rem;
            color: #fff;
            box-shadow: 0 4px 16px rgba(0,0,0,0.3);
        }

        .blackboard-back-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }

        .blackboard-toolbar {
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(8px);
            padding: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
            border-top: 1px solid rgba(255,255,255,0.08);
        }

        .color-panel {
            background: rgba(255,255,255,0.08);
            border: 2px solid rgba(255,255,255,0.15);
            border-radius: 25px;
            padding: 10px 15px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
        }

        .color-panel-label {
            color: #fff;
            font-size: 0.85rem;
            font-weight: 600;
            font-family: 'Vazirmatn', sans-serif;
            margin-left: 5px;
        }

        .color-btn {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.25);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .color-btn:hover, .color-btn.active {
            transform: scale(1.15);
            box-shadow: 0 0 12px rgba(255,255,255,0.35);
            border-width: 3px;
        }

        .tool-btn {
            padding: 8px 18px;
            background: rgba(255,255,255,0.12);
            border: 2px solid rgba(255,255,255,0.2);
            color: #fff;
            font-weight: bold;
            font-size: 0.9rem;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.2s ease;
            backdrop-filter: blur(5px);
            font-family: 'Vazirmatn', sans-serif;
        }

        .tool-btn:hover {
            background: rgba(255,255,255,0.2);
            transform: scale(1.05);
        }

        .brush-size-control {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255,255,255,0.08);
            padding: 6px 14px;
            border-radius: 25px;
            border: 2px solid rgba(255,255,255,0.15);
        }

        .brush-size-control label {
            color: #fff;
            font-size: 0.85rem;
            font-weight: 600;
            font-family: 'Vazirmatn', sans-serif;
        }

        .brush-size-control input {
            width: 80px;
            cursor: pointer;
        }

        /* ========================================
           SUPPORT CHAT STYLES
           ======================================== */
        .chat-container {
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            margin-bottom: 15px;
        }

        .chat-message {
            padding: 10px;
            margin: 8px 0;
            border-radius: 12px;
            max-width: 85%;
        }

        .chat-message.user {
            background: rgba(59, 130, 246, 0.2);
            margin-left: auto;
            text-align: right;
        }

        .chat-message.admin {
            background: rgba(34, 197, 94, 0.2);
            margin-right: auto;
        }

        .chat-input-area {
            display: flex;
            gap: 10px;
        }

        .question-item {
            background: rgba(255, 255, 255, 0.6);
            border: 1.5px solid rgba(255, 255, 255, 0.8);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 12px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .question-item:hover {
            background: rgba(255, 255, 255, 0.75);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        .question-item.answered {
            background: rgba(220, 252, 231, 0.6);
            border-color: rgba(34, 197, 94, 0.4);
        }

        .question-item.pending {
            background: rgba(254, 243, 199, 0.6);
            border-color: rgba(251, 191, 36, 0.4);
        }

        body.dark-mode .question-item {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.08);
        }

        /* ========================================
           FACTORIZE ENHANCED STYLES
           ======================================== */
        .power-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            margin: 4px;
            background: rgba(99, 102, 241, 0.15);
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
            color: #4f46e5;
            cursor: default;
            transition: all 0.3s ease;
            animation: slideIn 0.3s ease-out;
        }

        body.dark-mode .power-badge {
            background: rgba(99, 102, 241, 0.25);
            border-color: rgba(99, 102, 241, 0.4);
            color: #818cf8;
        }

        .power-badge:hover {
            background: rgba(99, 102, 241, 0.25);
            transform: scale(1.05);
        }

        .power-input {
            width: 50px;
            height: 28px;
            border-radius: 8px;
            border: 1px solid rgba(99, 102, 241, 0.3);
            background: rgba(255, 255, 255, 0.8);
            text-align: center;
            font-weight: bold;
            color: #4f46e5;
            transition: all 0.2s ease;
        }

        .power-input:focus {
            outline: none;
            border-color: rgba(99, 102, 241, 0.6);
            box-shadow: 0 0 8px rgba(99, 102, 241, 0.3);
        }

        body.dark-mode .power-input {
            background: rgba(0, 0, 0, 0.3);
            border-color: rgba(99, 102, 241, 0.4);
            color: #818cf8;
        }

        .remove-power-btn {
            background: rgba(220, 38, 38, 0.2);
            color: #dc2626;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.2s ease;
            font-weight: bold;
        }

        .remove-power-btn:hover {
            background: rgba(220, 38, 38, 0.4);
            transform: scale(1.1);
        }

        .variable-tag {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 6px 12px;
            margin: 4px;
            background: rgba(34, 197, 94, 0.15);
            border: 1px solid rgba(34, 197, 94, 0.3);
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            color: #059669;
            font-family: 'Tahoma', monospace;
        }

        body.dark-mode .variable-tag {
            background: rgba(34, 197, 94, 0.2);
            border-color: rgba(34, 197, 94, 0.35);
            color: #34d399;
        }

        .remove-var-btn {
            background: rgba(220, 38, 38, 0.2);
            color: #dc2626;
            border: none;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 0.7rem;
            transition: all 0.2s ease;
        }

        .remove-var-btn:hover {
            background: rgba(220, 38, 38, 0.4);
            transform: scale(1.1);
        }

        .add-variable-btn {
            background: rgba(59, 130, 246, 0.15);
            border: 2px dashed rgba(59, 130, 246, 0.4);
            color: #2563eb;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .add-variable-btn:hover {
            background: rgba(59, 130, 246, 0.25);
            border-color: rgba(59, 130, 246, 0.6);
            transform: scale(1.05);
        }

        body.dark-mode .add-variable-btn {
            background: rgba(59, 130, 246, 0.2);
            border-color: rgba(59, 130, 246, 0.35);
            color: #60a5fa;
        }

        /* ========================================
           FACTORIZATION RESULT DISPLAY
           ======================================== */
        .factorization-display {
            font-family: 'Tahoma', monospace;
            direction: ltr;
            text-align: center;
            padding: 1rem;
            background: rgba(99, 102, 241, 0.05);
            border: 2px solid rgba(99, 102, 241, 0.2);
            border-radius: 1rem;
            font-size: 1.2rem;
            font-weight: bold;
            color: #4f46e5;
        }

        body.dark-mode .factorization-display {
            background: rgba(99, 102, 241, 0.15);
            border-color: rgba(99, 102, 241, 0.3);
            color: #818cf8;
        }

        @keyframes fadeInSlide {
            from {
                opacity: 0;
                transform: translateX(-10px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* ========================================
           BOTTOM NAVIGATION
           ======================================== */
        .bottom-nav {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: calc(100% - 2rem);
            max-width: 28rem;
            z-index: 100;
        }
    </style>
</head>
<body class="selection:bg-gray-300 selection:text-gray-900 transition-colors duration-500">

    <!-- ========================================
         LOADING SPINNER
         ======================================== -->
    <div id="loading-spinner">
        <div class="spinner-ring"></div>
    </div>

    <!-- ========================================
         LOGIN OVERLAY
         ======================================== -->
    <div id="login-overlay" style="display: none;">
        <div class="glass-panel p-8 rounded-[2rem] flex flex-col gap-5 w-full max-w-sm text-center border-2 shadow-2xl">
            <h2 class="text-2xl font-bold font-sans mb-2">ÿÆŸàÿ¥ ÿ¢ŸÖÿØ€åÿØ</h2>
            <div class="flex flex-col gap-3">
                <input type="text" id="login-fname" class="glass-input w-full h-12 rounded-xl text-center text-lg placeholder-gray-600" placeholder="ŸÜÿßŸÖ">
                <input type="text" id="login-lname" class="glass-input w-full h-12 rounded-xl text-center text-lg placeholder-gray-600" placeholder="ŸÜÿßŸÖ ÿÆÿßŸÜŸàÿßÿØ⁄Ø€å">
            </div>
            <button onclick="submitLogin()" class="btn-bubble w-full h-12 rounded-xl text-black font-bold text-lg mt-2 shadow-lg hover:bg-white/90 transition-all">Ÿàÿ±ŸàÿØ</button>
        </div>
    </div>

    <!-- ========================================
         INTRO OVERLAY
         ======================================== -->
    <div id="intro-overlay">
        <div id="intro-special-msg" class="intro-text-style hidden"></div>
        <div id="intro-hello" class="intro-text-style">Hello</div>
        <div id="intro-sub" class="intro-text-style hidden">Amirhosein And Abolfazl pro calculator</div>
        <div id="intro-welcome" class="intro-text-style hidden">Welcome to Pro Calculator</div>
    </div>

    <!-- ========================================
         BLACKBOARD OVERLAY
         ======================================== -->
    <div id="blackboard-overlay">
        <!-- Back Button -->
        <div class="blackboard-back-btn" onclick="closeBlackboard()">‚úï</div>

        <!-- Canvas Container -->
        <div id="blackboard-canvas-container">
            <div id="blackboard-border">
                <canvas id="blackboard-canvas"></canvas>
            </div>
        </div>

        <!-- Toolbar -->
        <div class="blackboard-toolbar">
            <div class="color-panel">
                <span class="color-panel-label">ÿ±ŸÜ⁄Ø‚ÄåŸáÿß:</span>
                <button class="color-btn active" style="background: #fff;" data-color="#fff"></button>
                <button class="color-btn" style="background: #ff0000;" data-color="#ff0000"></button>
                <button class="color-btn" style="background: #00ff00;" data-color="#00ff00"></button>
                <button class="color-btn" style="background: #0000ff;" data-color="#0000ff"></button>
                <button class="color-btn" style="background: #ffff00;" data-color="#ffff00"></button>
                <button class="color-btn" style="background: #ff00ff;" data-color="#ff00ff"></button>
                <button class="color-btn" style="background: #00ffff;" data-color="#00ffff"></button>
                <button class="color-btn" style="background: #ffa500;" data-color="#ffa500"></button>
                <button class="color-btn" style="background: #ff69b4;" data-color="#ff69b4"></button>
                <button class="color-btn" style="background: #8b4513;" data-color="#8b4513"></button>
                <button class="color-btn" style="background: #808080;" data-color="#808080"></button>
                <button class="color-btn" style="background: #ffd700;" data-color="#ffd700"></button>
                <button class="color-btn" style="background: #00ced1;" data-color="#00ced1"></button>
                <button class="color-btn" style="background: #ff1493;" data-color="#ff1493"></button>
                <button class="color-btn" style="background: #7fff00;" data-color="#7fff00"></button>
            </div>
            
            <div class="brush-size-control">
                <label>ÿßŸÜÿØÿßÿ≤Ÿá:</label>
                <input type="range" id="brush-size" min="1" max="15" value="3">
            </div>

            <button class="tool-btn" onclick="toggleEraser()">Ÿæÿß⁄©‚Äå⁄©ŸÜ</button>
            <button class="tool-btn" onclick="clearBlackboard()">Ÿæÿß⁄© ⁄©ÿ±ÿØŸÜ ŸáŸÖŸá</button>
        </div>
    </div>

    <!-- ========================================
         TOAST NOTIFICATION
         ======================================== -->
    <div id="toast">ŸÖÿ™ŸÜ Ÿæ€åÿßŸÖ</div>

    <!-- ========================================
         MAIN APP CONTENT
         ======================================== -->
    <div id="main-app-container" class="app-container w-full h-full flex flex-col items-center justify-center relative">

        <div id="user-name-badge" class="hidden"></div>

        <!-- MENU BUTTON -->
        <div class="glass-menu-btn" onclick="toggleMenu()">
            <div class="dot bg-gray-800 dark:bg-white"></div>
            <div class="dot bg-gray-800 dark:bg-white"></div>
            <div class="dot bg-gray-800 dark:bg-white"></div>
        </div>

        <!-- DROPDOWN MENU -->
        <div id="main-menu" class="menu-dropdown">
            <div class="menu-item" onclick="openSettings()">‚öôÔ∏è ÿ™ŸÜÿ∏€åŸÖÿßÿ™</div>
            <div class="menu-item" onclick="openHistory()">üìú ÿ™ÿßÿ±€åÿÆ⁄ÜŸá</div>
            <div class="menu-item" onclick="openCalculations()">üßÆ ŸÖÿ≠ÿßÿ≥ÿ®ÿßÿ™</div>
            <div class="menu-item" onclick="openPowerConvert()">‚ö° ÿ™ŸàÿßŸÜ Ÿà ÿ™ÿ®ÿØ€åŸÑ</div>
            <div class="menu-item" onclick="openBMI()">üí™ ÿ¥ÿßÿÆÿµ ÿ™ŸàÿØŸá ÿ®ÿØŸÜ€å</div>
            <div class="menu-item" onclick="openBlackboard()">üñåÔ∏è ÿ™ÿÆÿ™Ÿá ÿ≥€åÿßŸá</div>
        </div>

        <!-- ========================================
             SETTINGS MODAL
             ======================================== -->
        <div id="settings-modal" class="modal-overlay">
            <div class="modal-content glass-panel rounded-[2rem] p-6 flex flex-col relative">
                <button onclick="closeModal('settings-modal')" class="absolute top-4 left-4 text-gray-600 hover:text-red-500 font-bold text-xl transition-colors dark:text-gray-300">‚úï</button>
                <h2 class="text-xl font-bold text-center mb-6 text-gray-800 dark:text-white">ÿ™ŸÜÿ∏€åŸÖÿßÿ™</h2>

                <div id="settings-content-wrapper" class="flex flex-col gap-6">
                    <!-- Support Button for Admin -->
                    <div id="admin-support-section" class="hidden">
                        <button onclick="openAdminSupport()" class="btn-bubble w-full py-3 rounded-xl text-gray-700 dark:text-gray-200 font-bold border-gray-300 hover:bg-white/90 transition-colors">
                            üí¨ ÿ≥ŸàÿßŸÑÿßÿ™ Ÿæÿ¥ÿ™€åÿ®ÿßŸÜ€å
                        </button>
                    </div>

                    <!-- Support Button for Regular Users -->
                    <div id="user-support-section">
                        <button onclick="openUserSupport()" class="btn-bubble w-full py-3 rounded-xl text-gray-700 dark:text-gray-200 font-bold border-gray-300 hover:bg-white/90 transition-colors">
                            üí¨ ÿßÿ±ÿ™ÿ®ÿßÿ∑ ÿ®ÿß Ÿæÿ¥ÿ™€åÿ®ÿßŸÜ€å
                        </button>
                    </div>

                    <!-- User Info Section -->
                    <div class="glass-panel rounded-xl p-4 flex flex-col items-center gap-2">
                        <div class="w-16 h-16 rounded-full bg-gray-300/50 flex items-center justify-center text-3xl">üë§</div>
                        <div class="text-sm text-gray-500 dark:text-gray-400">⁄©ÿßÿ±ÿ®ÿ± ŸÅÿπŸÑ€å</div>
                        <div id="settings-user-name" class="text-lg font-bold text-gray-800 dark:text-white">---</div>
                    </div>

                    <!-- Theme Toggle Section -->
                    <div class="glass-panel rounded-xl p-4 flex items-center justify-between cursor-pointer hover:bg-white/80 transition-all" onclick="toggleTheme()">
                        <span class="text-gray-700 dark:text-gray-200 font-semibold">ÿ≠ÿßŸÑÿ™ ÿ¥ÿ® (Dark Mode)</span>
                        <div class="relative w-12 h-6 rounded-full bg-gray-400 dark:bg-green-500 transition-colors">
                            <div class="absolute top-1 left-1 bg-white w-4 h-4 rounded-full transition-transform transform dark:translate-x-6"></div>
                        </div>
                    </div>

                    <!-- Credits Section -->
                    <div class="glass-panel rounded-xl p-4 flex flex-col gap-3 text-sm text-gray-700 dark:text-gray-300">
                        <div class="text-center font-bold text-base mb-2 border-b border-gray-300/30 pb-2 dark:border-gray-600/30">ÿßÿπÿ™ÿ®ÿßÿ±ÿßÿ™</div>
                        
                        <div class="flex flex-col gap-1">
                            <div class="font-semibold text-xs text-gray-500 dark:text-gray-400">ÿ∑ÿ±ÿßÿ≠ Ÿà ÿ®ÿ±ŸÜÿßŸÖŸá‚ÄåŸÜŸà€åÿ≥:</div>
                            <div class="font-bold">ÿßŸÖ€åÿ±ÿ≠ÿ≥€åŸÜ ŸÜÿßÿØÿ±€å</div>
                        </div>

                        <div class="flex flex-col gap-1">
                            <div class="font-semibold text-xs text-gray-500 dark:text-gray-400">ÿßÿ≥ŸæÿßŸÜÿ≥ÿ±ÿå ÿß€åÿØŸá‚ÄåŸæÿ±ÿØÿßÿ≤ Ÿà ÿØÿ≥ÿ™€åÿßÿ± ÿ®ÿ±ŸÜÿßŸÖŸá‚ÄåŸÜŸà€åÿ≥:</div>
                            <div class="font-bold">ÿßÿ®ŸàÿßŸÑŸÅÿ∂ŸÑ ÿ≠ÿ∂ÿ±ÿ™€å‚Äåÿ≤ÿßÿØŸá</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========================================
             USER SUPPORT MODAL
             ======================================== -->
        <div id="user-support-modal" class="modal-overlay">
            <div class="modal-content glass-panel rounded-[2rem] p-6 flex flex-col relative">
                <button onclick="closeModal('user-support-modal')" class="absolute top-4 left-4 text-gray-600 hover:text-red-500 font-bold text-xl transition-colors dark:text-gray-300">‚úï</button>
                <h2 class="text-xl font-bold text-center mb-4 text-gray-800 dark:text-white">ÿßÿ±ÿ™ÿ®ÿßÿ∑ ÿ®ÿß Ÿæÿ¥ÿ™€åÿ®ÿßŸÜ€å</h2>
                
                <div class="flex flex-col gap-4">
                    <textarea id="support-question" class="glass-input w-full h-32 rounded-xl text-right p-4 resize-none" placeholder="ÿ≥ŸàÿßŸÑ ÿÆŸàÿØ ÿ±ÿß ÿ®ŸÜŸà€åÿ≥€åÿØ..."></textarea>
                    <button onclick="submitSupportQuestion()" class="btn-bubble btn-eq w-full h-12 rounded-xl text-lg font-semibold shadow-lg">ÿßÿ±ÿ≥ÿßŸÑ ÿ≥ŸàÿßŸÑ</button>
                    
                    <div class="glass-panel rounded-xl p-4 mt-2">
                        <h3 class="font-bold text-sm mb-3 text-gray-700 dark:text-gray-200 border-b border-gray-300/30 pb-2">ÿ≥ŸàÿßŸÑÿßÿ™ ÿ¥ŸÖÿß:</h3>
                        <div id="user-questions-list" class="flex flex-col gap-2 max-h-60 overflow-y-auto">
                            <p class="text-xs text-gray-500 text-center py-2">ÿ≥ŸàÿßŸÑ€å ÿ´ÿ®ÿ™ ŸÜÿ¥ÿØŸá ÿßÿ≥ÿ™</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========================================
             ADMIN SUPPORT MODAL
             ======================================== -->
        <div id="admin-support-modal" class="modal-overlay">
            <div class="modal-content glass-panel rounded-[2rem] p-6 flex flex-col relative">
                <button onclick="closeModal('admin-support-modal')" class="absolute top-4 left-4 text-gray-600 hover:text-red-500 font-bold text-xl transition-colors dark:text-gray-300">‚úï</button>
                <h2 class="text-xl font-bold text-center mb-4 text-gray-800 dark:text-white">ÿ≥ŸàÿßŸÑÿßÿ™ Ÿæÿ¥ÿ™€åÿ®ÿßŸÜ€å</h2>
                
                <div id="admin-questions-list" class="flex flex-col gap-3 overflow-y-auto max-h-[60vh]">
                    <p class="text-center text-gray-500">ÿØÿ± ÿ≠ÿßŸÑ ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å...</p>
                </div>
            </div>
        </div>

        <!-- ========================================
             ANSWER QUESTION MODAL
             ======================================== -->
        <div id="answer-modal" class="modal-overlay">
            <div class="modal-content glass-panel rounded-[2rem] p-6 flex flex-col relative">
                <button onclick="closeModal('answer-modal')" class="absolute top-4 left-4 text-gray-600 hover:text-red-500 font-bold text-xl transition-colors dark:text-gray-300">‚úï</button>
                <h2 class="text-xl font-bold text-center mb-4 text-gray-800 dark:text-white">Ÿæÿßÿ≥ÿÆ ÿ®Ÿá ÿ≥ŸàÿßŸÑ</h2>
                
                <div class="flex flex-col gap-4">
                    <div class="glass-panel p-4 rounded-xl">
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">ÿ≥ŸàÿßŸÑ ⁄©ÿßÿ±ÿ®ÿ±:</p>
                        <p id="question-text" class="font-bold text-gray-800 dark:text-white"></p>
                        <p class="text-xs text-gray-500 mt-2" id="question-user"></p>
                    </div>
                    
                    <textarea id="answer-text" class="glass-input w-full h-32 rounded-xl text-right p-4 resize-none" placeholder="Ÿæÿßÿ≥ÿÆ ÿÆŸàÿØ ÿ±ÿß ÿ®ŸÜŸà€åÿ≥€åÿØ..."></textarea>
                    <button onclick="submitAnswer()" class="btn-bubble btn-eq w-full h-12 rounded-xl text-lg font-semibold shadow-lg">ÿßÿ±ÿ≥ÿßŸÑ Ÿæÿßÿ≥ÿÆ</button>
                </div>
            </div>
        </div>

        <!-- ========================================
             HISTORY MODAL
             ======================================== -->
        <div id="history-modal" class="modal-overlay">
            <div class="modal-content glass-panel rounded-[2rem] p-6 flex flex-col relative">
                <button onclick="closeModal('history-modal')" class="absolute top-4 left-4 text-gray-600 hover:text-red-500 font-bold text-xl transition-colors dark:text-gray-300">‚úï</button>
                <h2 class="text-xl font-bold text-center mb-4 text-gray-800">ÿ™ÿßÿ±€åÿÆ⁄ÜŸá ŸÖÿ≠ÿßÿ≥ÿ®ÿßÿ™</h2>
                <p class="text-center text-xs text-gray-500 mb-2">ÿ®ÿ±ÿß€å ⁄©Ÿæ€å ÿ±Ÿà€å ŸÜÿ™€åÿ¨Ÿá ⁄©ŸÑ€å⁄© ⁄©ŸÜ€åÿØ</p>
                <div id="history-list" class="flex flex-col gap-2 overflow-y-auto max-h-[60vh] pr-1">
                    <div class="text-center text-gray-500 py-4">ŸáŸÜŸàÿ≤ ŸÖÿ≠ÿßÿ≥ÿ®Ÿá‚Äåÿß€å ÿßŸÜÿ¨ÿßŸÖ ŸÜÿ¥ÿØŸá</div>
                </div>
                <button onclick="clearHistory()" class="btn-bubble mt-4 py-2 rounded-xl text-red-700 text-sm font-semibold">Ÿæÿß⁄© ⁄©ÿ±ÿØŸÜ ÿ™ÿßÿ±€åÿÆ⁄ÜŸá</button>
            </div>
        </div>

        <!-- ========================================
             CALCULATIONS MODAL (Age + Discount)
             ======================================== -->
        <div id="calculations-modal" class="modal-overlay">
            <div class="modal-content glass-panel rounded-[2rem] p-6 flex flex-col relative">
                <button onclick="closeModal('calculations-modal')" class="absolute top-4 left-4 text-gray-600 hover:text-red-500 font-bold text-xl transition-colors dark:text-gray-300">‚úï</button>
                <h2 class="text-xl font-bold text-center mb-4 text-gray-800 dark:text-white">ŸÖÿ≠ÿßÿ≥ÿ®ÿßÿ™</h2>

                <div class="glass-panel p-1.5 rounded-full flex gap-1 mb-4">
                    <button onclick="setCalcMode('age')" id="btn-calc-age" class="flex-1 py-2 rounded-full text-xs font-semibold bg-white/70 dark:bg-white/20 text-gray-900 dark:text-white shadow-sm transition-all">ŸÖÿ≠ÿßÿ≥ÿ®Ÿá ÿ≥ŸÜ</button>
                    <button onclick="setCalcMode('discount')" id="btn-calc-discount" class="flex-1 py-2 rounded-full text-xs font-semibold text-gray-600 dark:text-gray-400 hover:bg-white/50 transition-all">ŸÖÿ≠ÿßÿ≥ÿ®Ÿá ÿ™ÿÆŸÅ€åŸÅ</button>
                </div>

                <div id="calculations-content"></div>
            </div>
        </div>

        <!-- ========================================
             POWER & CONVERT MODAL
             ======================================== -->
        <div id="power-convert-modal" class="modal-overlay">
            <div class="modal-content glass-panel rounded-[2rem] p-6 flex flex-col relative">
                <button onclick="closeModal('power-convert-modal')" class="absolute top-4 left-4 text-gray-600 hover:text-red-500 font-bold text-xl transition-colors dark:text-gray-300">‚úï</button>
                <h2 class="text-xl font-bold text-center mb-4 text-gray-800 dark:text-white">ÿ™ŸàÿßŸÜ Ÿà ÿ™ÿ®ÿØ€åŸÑ</h2>

                <div class="glass-panel p-1.5 rounded-full flex gap-1 mb-4">
                    <button onclick="setPowerConvertMode('power')" id="btn-pc-power" class="flex-1 py-2 rounded-full text-xs font-semibold bg-white/70 dark:bg-white/20 text-gray-900 dark:text-white shadow-sm transition-all">ÿ™ŸàÿßŸÜ</button>
                    <button onclick="setPowerConvertMode('convert')" id="btn-pc-convert" class="flex-1 py-2 rounded-full text-xs font-semibold text-gray-600 dark:text-gray-400 hover:bg-white/50 transition-all">ÿ™ÿ®ÿØ€åŸÑ Ÿàÿßÿ≠ÿØ</button>
                </div>

                <div id="power-convert-content"></div>
            </div>
        </div>

        <!-- ========================================
             BMI CALCULATOR MODAL
             ======================================== -->
        <div id="bmi-modal" class="modal-overlay">
            <div class="modal-content glass-panel rounded-[2rem] p-6 flex flex-col relative">
                <button onclick="closeModal('bmi-modal')" class="absolute top-4 left-4 text-gray-600 hover:text-red-500 font-bold text-xl transition-colors dark:text-gray-300">‚úï</button>
                <h2 class="text-xl font-bold text-center mb-4 text-gray-800 dark:text-white">ÿ¥ÿßÿÆÿµ ÿ™ŸàÿØŸá ÿ®ÿØŸÜ€å (BMI)</h2>
                <div class="flex flex-col gap-4">
                    <input type="number" id="bmi-height" class="glass-input w-full h-12 rounded-xl text-center text-lg font-mono" placeholder="ŸÇÿØ (ÿ≥ÿßŸÜÿ™€å‚ÄåŸÖÿ™ÿ±)">
                    <input type="number" id="bmi-weight" class="glass-input w-full h-12 rounded-xl text-center text-lg font-mono" placeholder="Ÿàÿ≤ŸÜ (⁄©€åŸÑŸà⁄Øÿ±ŸÖ)">
                    <button onclick="calcBMI()" class="btn-bubble btn-eq h-12 rounded-xl text-lg font-semibold shadow-lg">ŸÖÿ≠ÿßÿ≥ÿ®Ÿá BMI</button>
                    <div id="bmi-result" class="glass-panel rounded-xl p-4 mt-2 text-center text-gray-800 dark:text-white">
                        ---
                    </div>
                </div>
            </div>
        </div>

        <!-- ========================================
             MAIN HEADER & CALCULATOR AREA
             ======================================== -->
        <header class="mb-4 animate-float mt-6">
            <div class="glass-panel rounded-full px-8 py-3 text-center border-2 shadow-lg">
                <h1 class="text-2xl md:text-3xl font-bold text-gray-800 dark:text-gray-100 tracking-tight drop-shadow-sm">
                    Pro Calculator
                </h1>
            </div>
        </header>

        <main class="w-full max-w-md px-4 pb-6">
            <div class="glass-panel rounded-[3rem] p-6 relative overflow-hidden min-h-[520px] flex flex-col shadow-xl">
                <div id="app-content" class="flex-1 flex flex-col relative transition-opacity duration-300">
                </div>
            </div>
        </main>

        <!-- ========================================
             BOTTOM NAVIGATION
             ======================================== -->
        <div class="bottom-nav">
            <div class="glass-panel rounded-full p-1.5 flex gap-1">
                <button onclick="switchTab('basic')" id="tab-basic" class="nav-pill active flex-1 py-2.5 rounded-full text-xs font-semibold text-gray-600 transition-all duration-300">Ÿæÿß€åŸá</button>
                <button onclick="switchTab('pythagoras')" id="tab-pythagoras" class="nav-pill flex-1 py-2.5 rounded-full text-xs font-semibold text-gray-600 transition-all duration-300">ŸÅ€åÿ´ÿßÿ∫Ÿàÿ±ÿ≥</button>
                <button onclick="switchTab('fraction')" id="tab-fraction" class="nav-pill flex-1 py-2.5 rounded-full text-xs font-semibold text-gray-600 transition-all duration-300">⁄©ÿ≥ÿ±</button>
                <button onclick="switchTab('factorize')" id="tab-factorize" class="nav-pill flex-1 py-2.5 rounded-full text-xs font-semibold text-gray-600 transition-all duration-300">ÿ™ÿ¨ÿ≤€åŸá</button>
                <button onclick="switchTab('equation')" id="tab-equation" class="nav-pill flex-1 py-2.5 rounded-full text-xs font-semibold text-gray-600 transition-all duration-300">ŸÖÿπÿßÿØŸÑŸá</button>
                <button onclick="switchTab('properties')" id="tab-properties" class="nav-pill flex-1 py-2.5 rounded-full text-xs font-semibold text-gray-600 transition-all duration-300">ÿÆŸàÿßÿµ</button>
                <button onclick="switchTab('sieve')" id="tab-sieve" class="nav-pill flex-1 py-2.5 rounded-full text-xs font-semibold text-gray-600 transition-all duration-300">ÿ∫ÿ±ÿ®ÿßŸÑ⁄Øÿ±€å</button>
                <button onclick="switchTab('metals')" id="tab-metals" class="nav-pill flex-1 py-2.5 rounded-full text-xs font-semibold text-gray-600 transition-all duration-300">ŸÅŸÑÿ≤ÿßÿ™</button>
            </div>
        </div>
    </div>

    <script>
        /* ========================================
           GLOBAL VARIABLES & STATE
           ======================================== */
        let currentTab = 'basic';
        let displayVal = '0';
        let calcHistory = [];
        let isDarkMode = false;
        let userData = {
            firstName: '',
            lastName: ''
        };

        let currentQuestionId = null;

        // BLACKBOARD VARIABLES
        let blackboardCanvas, blackboardCtx;
        let isDrawing = false;
        let currentColor = '#fff';
        let brushSize = 3;
        let isEraser = false;
        let lastX = 0, lastY = 0;

        // PROPERTIES SUB-TAB
        let propertiesSubTab = 'number';

        // FACTORIZE SUB-TAB
        let factorizeSubTab = 'algebraic';
        let variablePowers = {};

        // CALCULATIONS MODE (Age or Discount)
        let calcMode = 'age';

        // POWER & CONVERT MODE
        let powerConvertMode = 'power';

        // Metal densities (g/cm¬≥)
        const metalDensities = {
            'gold': 19.32,
            'silver': 10.49,
            'copper': 8.96,
            'aluminum': 2.70,
            'iron': 7.87,
            'platinum': 21.45,
            'titanium': 4.51,
            'zinc': 7.14,
            'nickel': 8.91,
            'tin': 7.31,
            'lead': 11.34,
            'brass': 8.53,
            'bronze': 8.80,
            'stainless': 7.93,
            'magnesium': 1.74,
            'tungsten': 19.25,
            'cobalt': 8.90,
            'chromium': 7.19
        };

        const metalNames = {
            'gold': 'ÿ∑ŸÑÿß',
            'silver': 'ŸÜŸÇÿ±Ÿá',
            'copper': 'ŸÖÿ≥',
            'aluminum': 'ÿ¢ŸÑŸàŸÖ€åŸÜ€åŸàŸÖ',
            'iron': 'ÿ¢ŸáŸÜ',
            'platinum': 'ŸæŸÑÿßÿ™€åŸÜ',
            'titanium': 'ÿ™€åÿ™ÿßŸÜ€åŸàŸÖ',
            'zinc': 'ÿ±Ÿà€å',
            'nickel': 'ŸÜ€å⁄©ŸÑ',
            'tin': 'ŸÇŸÑÿπ',
            'lead': 'ÿ≥ÿ±ÿ®',
            'brass': 'ÿ®ÿ±ŸÜÿ¨',
            'bronze': 'ÿ®ÿ±ŸÜÿ≤',
            'stainless': 'ÿßÿ≥ÿ™€åŸÑ',
            'magnesium': 'ŸÖŸÜ€åÿ≤€åŸÖ',
            'tungsten': 'ÿ™ŸÜ⁄Øÿ≥ÿ™ŸÜ',
            'cobalt': '⁄©ÿ®ÿßŸÑÿ™',
            'chromium': '⁄©ÿ±ŸàŸÖ'
        };

        /* ========================================
           INITIALIZATION
           ======================================== */
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                document.getElementById('loading-spinner').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('loading-spinner').style.display = 'none';
                    checkUserAndStart();
                }, 500);
            }, 1000);

            updateConvOptions();
            initBlackboard();
        });

        /* ========================================
           UTILITY FUNCTIONS
           ======================================== */
        
        /**
         * Normalizes a string by removing spaces and converting to lowercase
         */
        function normalizeString(str) {
            return str.replace(/\s+/g, '').toLowerCase();
        }

        /**
         * Computes greatest common divisor
         */
        function gcd(a, b) { 
            return b == 0 ? a : gcd(b, a % b); 
        }

        /**
         * Shows a toast notification
         */
        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.innerText = msg;
            toast.classList.add('show');
            setTimeout(() => { toast.classList.remove('show'); }, 2000);
        }

        /**
         * Copies text to clipboard
         */
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showToast('⁄©Ÿæ€å ÿ¥ÿØ!');
            }).catch(() => {
                try {
                    const el = document.createElement('textarea');
                    el.value = text;
                    document.body.appendChild(el);
                    el.select();
                    document.execCommand('copy');
                    document.body.removeChild(el);
                    showToast('⁄©Ÿæ€å ÿ¥ÿØ!');
                } catch(e) {
                    showToast('ÿÆÿ∑ÿß ÿØÿ± ⁄©Ÿæ€å');
                }
            });
        }

        /**
         * Adds calculation to history
         */
        function addToHistory(expression, result) {
            if (result === 'Error') return;
            calcHistory.unshift({ exp: expression, res: result });
            if (calcHistory.length > 10) calcHistory.pop(); 
        }

        /* ========================================
           USER AUTHENTICATION & INTRO
           ======================================== */
        
        /**
         * Checks if user is logged in and starts intro sequence
         */
        function checkUserAndStart() {
            const savedFName = localStorage.getItem('ah_user_fname');
            const savedLName = localStorage.getItem('ah_user_lname');

            if (savedFName && savedLName) {
                userData.firstName = savedFName;
                userData.lastName = savedLName;
                startIntroSequence();
            } else {
                document.getElementById('login-overlay').style.display = 'flex';
            }
        }

        /**
         * Handles login form submission
         */
        function submitLogin() {
            const fName = document.getElementById('login-fname').value.trim();
            const lName = document.getElementById('login-lname').value.trim();

            if (!fName || !lName) {
                showToast('ŸÑÿ∑ŸÅÿßŸã ŸÜÿßŸÖ Ÿà ŸÜÿßŸÖ ÿÆÿßŸÜŸàÿßÿØ⁄Ø€å ÿ±ÿß Ÿàÿßÿ±ÿØ ⁄©ŸÜ€åÿØ');
                return;
            }

            localStorage.setItem('ah_user_fname', fName);
            localStorage.setItem('ah_user_lname', lName);
            userData.firstName = fName;
            userData.lastName = lName;

            const loginOverlay = document.getElementById('login-overlay');
            loginOverlay.style.opacity = '0';

            setTimeout(() => {
                loginOverlay.style.display = 'none';
                startIntroSequence();
            }, 1000);
        }

        /**
         * Starts the intro animation sequence
         */
        function startIntroSequence() {
            const overlay = document.getElementById('intro-overlay');
            const helloText = document.getElementById('intro-hello');
            const subText = document.getElementById('intro-sub');
            const welcomeText = document.getElementById('intro-welcome');
            const specialMsg = document.getElementById('intro-special-msg');
            const mainApp = document.getElementById('main-app-container');
            const userBadge = document.getElementById('user-name-badge');

            // Special teachers list
            const specialTeachers = [
                { f: 'ÿ≠ÿßŸÖÿØ', l: 'ŸÖŸàŸÑÿß€å€å' },
                { f: 'ÿ≠ÿ≥€åŸÜ', l: 'ÿ®ÿÆÿ™€åÿßÿ±€å' },
                { f: 'ŸÖÿ≠ŸÖÿØ', l: 'ŸÇÿßÿ≥ŸÖ€å' },
                { f: 'ŸÖÿµÿ∑ŸÅ€å', l: 'ÿ¥ÿπÿ®ÿßŸÜ€å' }
            ];

            const foundTeacher = specialTeachers.find(t => 
                t.f === userData.firstName.trim() && t.l === userData.lastName.trim()
            );

            // Set user badge text
            if (foundTeacher) {
                userBadge.innerText = `ÿßÿ≥ÿ™ÿßÿØ ${userData.lastName} ÿπÿ≤€åÿ≤`;
            } else {
                userBadge.innerText = `${userData.firstName} ÿπÿ≤€åÿ≤`;
            }

            userBadge.classList.remove('hidden');

            overlay.classList.add('active');

            const f = userData.firstName.trim();
            const l = userData.lastName.trim();

            // Check if user is Abolfazl Hazratizadeh
            const isAbolfazl = f.includes('ÿßÿ®ŸàÿßŸÑŸÅÿ∂ŸÑ') || f.toLowerCase().includes('abolfazl');
            const isHazrati = l.includes('ÿ≠ÿ∂ÿ±ÿ™€å') || l.includes('ÿ≠ÿ∂ÿ±ÿ™€å ÿ≤ÿßÿØŸá') || l.includes('ÿ≠ÿ∂ÿ±ÿ™€å‚Äåÿ≤ÿßÿØŸá') || l.toLowerCase().includes('hazrati');

            if (isAbolfazl && isHazrati) {
                // Special message for Abolfazl
                specialMsg.innerHTML = 'ÿßŸÖ€åÿØŸàÿßÿ±ŸÖ ÿØÿ± ŸÖÿ≥ÿßÿ®ŸÇÿßÿ™ ÿßŸàŸÑ ÿ¥€åŸÖ ÿßÿ®ŸàÿßŸÑŸÅÿ∂ŸÑ ÿ≠ÿ∂ÿ±ÿ™€å ÿπÿ≤€åÿ≤ ŸÖŸÖŸÜŸàŸÜ ⁄©Ÿá Ÿæÿß ÿ®Ÿá ŸæÿßŸÖ ÿ™ŸÑÿßÿ¥ ⁄©ÿ±ÿØ€å ÿ™ÿß ÿß€åŸÜ ÿ±Ÿà ÿ®Ÿá ÿß€åŸÜ ÿØÿ±ÿ¨Ÿá ÿ®ÿ±ÿ≥ŸàŸÜ€åŸÖ';
                specialMsg.classList.remove('hidden');

                setTimeout(() => {
                    specialMsg.style.opacity = '1';
                    specialMsg.style.transform = 'translateY(0)';
                }, 300);

                setTimeout(() => {
                    helloText.style.opacity = '1';
                    helloText.style.transform = 'translateY(0)';
                }, 2500);

                setTimeout(() => {
                    subText.classList.remove('hidden');
                    subText.style.opacity = '1';
                    subText.style.transform = 'translateY(0)';
                }, 4000);

                setTimeout(() => {
                    overlay.style.opacity = '0';
                    mainApp.classList.add('app-visible');
                    setTimeout(() => { overlay.style.display = 'none'; renderBasic(); }, 1500); 
                }, 7000);

            } else {
                // Standard intro sequence
                setTimeout(() => {
                    helloText.style.opacity = '1';
                    helloText.style.transform = 'translateY(0)';
                }, 300);

                // After 1.5 seconds, fade out hello and show welcome
                setTimeout(() => {
                    helloText.style.opacity = '0';
                    helloText.style.transform = 'translateY(-30px)';
                }, 1800);

                setTimeout(() => {
                    helloText.style.display = 'none';
                    welcomeText.classList.remove('hidden');
                    welcomeText.style.opacity = '1';
                    welcomeText.style.transform = 'translateY(0)';
                }, 2300);

                setTimeout(() => {
                    overlay.style.opacity = '0';
                    mainApp.classList.add('app-visible');
                    setTimeout(() => { overlay.style.display = 'none'; renderBasic(); }, 1500); 
                }, 5000);
            }
        }

        /* ========================================
           MENU & NAVIGATION
           ======================================== */
        
        /**
         * Toggles the main menu dropdown
         */
        function toggleMenu() {
            const menu = document.getElementById('main-menu');
            menu.classList.toggle('show');
        }

        /**
         * Close menu when clicking outside
         */
        window.addEventListener('click', (e) => {
            const menu = document.getElementById('main-menu');
            const btn = document.querySelector('.glass-menu-btn');
            if (!menu.contains(e.target) && !btn.contains(e.target)) {
                menu.classList.remove('show');
            }
        });

        /**
         * Toggles dark mode
         */
        function toggleTheme() {
            isDarkMode = !isDarkMode;
            document.body.classList.toggle('dark-mode');
        }

        /**
         * Closes a modal by ID
         */
        function closeModal(id) { 
            document.getElementById(id).classList.remove('open'); 
        }

        /* ========================================
           SETTINGS MODAL
           ======================================== */
        
        /**
         * Opens settings modal
         */
        function openSettings() {
            document.getElementById('settings-user-name').innerText = `${userData.firstName} ${userData.lastName}`;

            // Check if admin
            const normalizedFirst = normalizeString(userData.firstName);
            const normalizedLast = normalizeString(userData.lastName);
            
            const isAmirhosein = (normalizedFirst === 'ÿßŸÖ€åÿ±ÿ≠ÿ≥€åŸÜ' || normalizedFirst === 'amirhosein') && 
                                (normalizedLast === 'ŸÜÿßÿØÿ±€å' || normalizedLast === 'naderi');
            
            const isAbolfazl = (normalizedFirst === 'ÿßÿ®ŸàÿßŸÑŸÅÿ∂ŸÑ' || normalizedFirst === 'abolfazl') && 
                              (normalizedLast === 'ÿ≠ÿ∂ÿ±ÿ™€å' || normalizedLast === 'ÿ≠ÿ∂ÿ±ÿ™€å‚Äåÿ≤ÿßÿØŸá' || normalizedLast === 'ÿ≠ÿ∂ÿ±ÿ™€åÿ≤ÿßÿØŸá' || normalizedLast === 'hazrati' || normalizedLast === 'hazratizadeh');

            if (isAmirhosein || isAbolfazl) {
                document.getElementById('admin-support-section').classList.remove('hidden');
                document.getElementById('user-support-section').classList.add('hidden');
            } else {
                document.getElementById('admin-support-section').classList.add('hidden');
                document.getElementById('user-support-section').classList.remove('hidden');
            }

            document.getElementById('settings-modal').classList.add('open');
            document.getElementById('main-menu').classList.remove('show');
        }

        /* ========================================
           SUPPORT FUNCTIONS
           ======================================== */
        
        /**
         * Opens user support modal
         */
        function openUserSupport() {
            loadUserQuestions();
            document.getElementById('user-support-modal').classList.add('open');
            closeModal('settings-modal');
        }

        /**
         * Loads user's support questions
         */
        function loadUserQuestions() {
            const questions = JSON.parse(localStorage.getItem('support_questions') || '[]');
            const userQuestions = questions.filter(q => 
                q.user === `${userData.firstName} ${userData.lastName}`
            );

            const listContainer = document.getElementById('user-questions-list');

            if (userQuestions.length === 0) {
                listContainer.innerHTML = '<p class="text-xs text-gray-500 text-center py-2">ÿ≥ŸàÿßŸÑ€å ÿ´ÿ®ÿ™ ŸÜÿ¥ÿØŸá ÿßÿ≥ÿ™</p>';
            } else {
                let html = '';
                userQuestions.forEach(q => {
                    const statusClass = q.answer ? 'answered' : 'pending';
                    const statusText = q.answer ? 'Ÿæÿßÿ≥ÿÆ ÿØÿßÿØŸá ÿ¥ÿØŸá ‚úì' : 'ŸÖŸÜÿ™ÿ∏ÿ± Ÿæÿßÿ≥ÿÆ...';
                    const statusColor = q.answer ? 'text-green-600' : 'text-yellow-600';
                    
                    html += `
                        <div class="question-item ${statusClass}">
                            <div class="flex justify-between items-start mb-2">
                                <span class="text-xs ${statusColor} font-bold">${statusText}</span>
                            </div>
                            <p class="text-sm text-gray-800 dark:text-white mb-2 font-semibold">${q.question}</p>
                            ${q.answer ? `
                                <div class="mt-2 pt-2 border-t border-gray-300/30">
                                    <p class="text-xs text-gray-600 dark:text-gray-400 mb-1 font-bold">Ÿæÿßÿ≥ÿÆ Ÿæÿ¥ÿ™€åÿ®ÿßŸÜ€å:</p>
                                    <p class="text-sm text-gray-700 dark:text-gray-200">${q.answer}</p>
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
                listContainer.innerHTML = html;
            }
        }

        /**
         * Submits a support question
         */
        function submitSupportQuestion() {
            const question = document.getElementById('support-question').value.trim();
            if (!question) {
                showToast('ŸÑÿ∑ŸÅÿßŸã ÿ≥ŸàÿßŸÑ ÿÆŸàÿØ ÿ±ÿß ÿ®ŸÜŸà€åÿ≥€åÿØ');
                return;
            }

            const questions = JSON.parse(localStorage.getItem('support_questions') || '[]');
            questions.push({
                id: Date.now(),
                user: `${userData.firstName} ${userData.lastName}`,
                question: question,
                answer: null,
                timestamp: new Date().toISOString()
            });

            localStorage.setItem('support_questions', JSON.stringify(questions));
            
            showToast('ÿ≥ŸàÿßŸÑ ÿ¥ŸÖÿß ÿ´ÿ®ÿ™ ÿ¥ÿØ Ÿà ÿ®ÿ≤ŸàÿØ€å Ÿæÿßÿ≥ÿÆ ÿØÿßÿØŸá ŸÖ€å‚Äåÿ¥ŸàÿØ');
            document.getElementById('support-question').value = '';
            loadUserQuestions();
        }

        /**
         * Opens admin support panel
         */
        function openAdminSupport() {
            const questions = JSON.parse(localStorage.getItem('support_questions') || '[]');
            const listContainer = document.getElementById('admin-questions-list');

            if (questions.length === 0) {
                listContainer.innerHTML = '<p class="text-center text-gray-500">ÿ≥ŸàÿßŸÑ€å ÿ´ÿ®ÿ™ ŸÜÿ¥ÿØŸá ÿßÿ≥ÿ™</p>';
            } else {
                let html = '';
                questions.forEach(q => {
                    const statusClass = q.answer ? 'answered' : 'pending';
                    const statusText = q.answer ? 'Ÿæÿßÿ≥ÿÆ ÿØÿßÿØŸá ÿ¥ÿØŸá ‚úì' : 'ŸÖŸÜÿ™ÿ∏ÿ± Ÿæÿßÿ≥ÿÆ';
                    const statusColor = q.answer ? 'text-green-600 dark:text-green-400' : 'text-yellow-600 dark:text-yellow-400';
                    
                    html += `
                        <div class="question-item ${statusClass}">
                            <div class="flex justify-between items-start mb-2">
                                <span class="text-xs font-bold text-gray-600 dark:text-gray-300">${q.user}</span>
                                <span class="text-xs font-bold ${statusColor}">${statusText}</span>
                            </div>
                            <p class="text-sm text-gray-800 dark:text-white mb-2 font-semibold">${q.question}</p>
                            ${q.answer ? `
                                <div class="text-xs text-gray-600 dark:text-gray-400 mt-2 pt-2 border-t border-gray-300/30">
                                    <strong>Ÿæÿßÿ≥ÿÆ ÿ¥ŸÖÿß:</strong> ${q.answer}
                                </div>
                            ` : `
                                <button onclick="answerQuestion(${q.id})" class="btn-bubble w-full mt-2 py-2 rounded-xl text-sm">Ÿæÿßÿ≥ÿÆ ÿØÿßÿØŸÜ</button>
                            `}
                        </div>
                    `;
                });
                listContainer.innerHTML = html;
            }

            document.getElementById('admin-support-modal').classList.add('open');
            closeModal('settings-modal');
        }

        /**
         * Opens answer modal for a specific question
         */
        function answerQuestion(questionId) {
            const questions = JSON.parse(localStorage.getItem('support_questions') || '[]');
            const question = questions.find(q => q.id === questionId);
            
            if (!question) return;

            currentQuestionId = questionId;
            document.getElementById('question-text').innerText = question.question;
            document.getElementById('question-user').innerText = `ÿßÿ≤: ${question.user}`;
            document.getElementById('answer-text').value = '';

            closeModal('admin-support-modal');
            document.getElementById('answer-modal').classList.add('open');
        }

        /**
         * Submits an answer to a support question
         */
        function submitAnswer() {
            const answer = document.getElementById('answer-text').value.trim();
            if (!answer) {
                showToast('ŸÑÿ∑ŸÅÿßŸã Ÿæÿßÿ≥ÿÆ ÿ±ÿß Ÿàÿßÿ±ÿØ ⁄©ŸÜ€åÿØ');
                return;
            }

            const questions = JSON.parse(localStorage.getItem('support_questions') || '[]');
            const questionIndex = questions.findIndex(q => q.id === currentQuestionId);
            
            if (questionIndex !== -1) {
                questions[questionIndex].answer = answer;
                localStorage.setItem('support_questions', JSON.stringify(questions));
                showToast('Ÿæÿßÿ≥ÿÆ ÿ®ÿß ŸÖŸàŸÅŸÇ€åÿ™ ÿ´ÿ®ÿ™ ÿ¥ÿØ');
                closeModal('answer-modal');
                openAdminSupport();
            }
        }

        /* ========================================
           HISTORY MODAL
           ======================================== */
        
        /**
         * Opens history modal
         */
        function openHistory() {
            document.getElementById('history-modal').classList.add('open');
            document.getElementById('main-menu').classList.remove('show');
            renderHistoryList();
        }

        /**
         * Renders calculation history list
         */
        function renderHistoryList() {
            const list = document.getElementById('history-list');
            if (calcHistory.length === 0) {
                list.innerHTML = '<div class="text-center text-gray-500 py-4">ŸáŸÜŸàÿ≤ ŸÖÿ≠ÿßÿ≥ÿ®Ÿá‚Äåÿß€å ÿßŸÜÿ¨ÿßŸÖ ŸÜÿ¥ÿØŸá</div>';
                return;
            }
            let html = '';
            calcHistory.forEach(item => {
                html += `
                    <div class="glass-panel p-3 rounded-xl mb-2 flex flex-col items-end border-2 cursor-pointer hover:bg-white/90 transition-colors" onclick="copyToClipboard('${item.res}')" title="⁄©Ÿæ€å ŸÜÿ™€åÿ¨Ÿá">
                        <span class="text-xs text-gray-500 font-mono dark:text-gray-400">${item.exp}</span>
                        <span class="text-lg font-bold text-gray-800 font-mono dark:text-white">= ${item.res}</span>
                    </div>
                `;
            });
            list.innerHTML = html;
        }

        /**
         * Clears calculation history
         */
        function clearHistory() {
            calcHistory = [];
            renderHistoryList();
        }

        /* ========================================
           CALCULATIONS MODAL (AGE + DISCOUNT)
           ======================================== */
        
        /**
         * Opens calculations modal
         */
        function openCalculations() {
            document.getElementById('calculations-modal').classList.add('open');
            document.getElementById('main-menu').classList.remove('show');
            setCalcMode('age'); // Default to age calculator
        }

        /**
         * Sets calculation mode (age or discount)
         */
        function setCalcMode(mode) {
            calcMode = mode;
            
            const ageBtn = document.getElementById('btn-calc-age');
            const discountBtn = document.getElementById('btn-calc-discount');
            
            if (mode === 'age') {
                ageBtn.className = "flex-1 py-2 rounded-full text-xs font-semibold bg-white/70 dark:bg-white/20 text-gray-900 dark:text-white shadow-sm transition-all";
                discountBtn.className = "flex-1 py-2 rounded-full text-xs font-semibold text-gray-600 dark:text-gray-400 hover:bg-white/50 transition-all";
                renderAgeCalculator();
            } else {
                discountBtn.className = "flex-1 py-2 rounded-full text-xs font-semibold bg-white/70 dark:bg-white/20 text-gray-900 dark:text-white shadow-sm transition-all";
                ageBtn.className = "flex-1 py-2 rounded-full text-xs font-semibold text-gray-600 dark:text-gray-400 hover:bg-white/50 transition-all";
                renderDiscountCalculator();
            }
        }

        /**
         * Renders age calculator UI with Jalali (Shamsi) calendar
         */
        function renderAgeCalculator() {
            document.getElementById('calculations-content').innerHTML = `
                <div class="flex flex-col gap-4">
                    <label class="text-sm text-gray-600 dark:text-gray-300 text-center block">ÿ™ÿßÿ±€åÿÆ ÿ™ŸàŸÑÿØ ÿÆŸàÿØ ÿ±ÿß Ÿàÿßÿ±ÿØ ⁄©ŸÜ€åÿØ (ÿ¥ŸÖÿ≥€å):</label>
                    
                    <div class="flex gap-2 justify-center">
                        <input type="number" id="age-year" class="glass-input w-20 h-12 rounded-xl text-center font-mono" placeholder="ÿ≥ÿßŸÑ" min="1300" max="1410">
                        <select id="age-month" class="glass-input w-24 h-12 rounded-xl text-center">
                            <option value="">ŸÖÿßŸá</option>
                            <option value="1">ŸÅÿ±Ÿàÿ±ÿØ€åŸÜ</option>
                            <option value="2">ÿßÿ±ÿØ€åÿ®Ÿáÿ¥ÿ™</option>
                            <option value="3">ÿÆÿ±ÿØÿßÿØ</option>
                            <option value="4">ÿ™€åÿ±</option>
                            <option value="5">ŸÖÿ±ÿØÿßÿØ</option>
                            <option value="6">ÿ¥Ÿáÿ±€åŸàÿ±</option>
                            <option value="7">ŸÖŸáÿ±</option>
                            <option value="8">ÿ¢ÿ®ÿßŸÜ</option>
                            <option value="9">ÿ¢ÿ∞ÿ±</option>
                            <option value="10">ÿØ€å</option>
                            <option value="11">ÿ®ŸáŸÖŸÜ</option>
                            <option value="12">ÿßÿ≥ŸÅŸÜÿØ</option>
                        </select>
                        <input type="number" id="age-day" class="glass-input w-16 h-12 rounded-xl text-center font-mono" placeholder="ÿ±Ÿàÿ≤" min="1" max="31">
                    </div>
                    
                    <button onclick="calcAge()" class="btn-bubble btn-eq h-12 rounded-xl text-lg font-semibold shadow-lg">ŸÖÿ≠ÿßÿ≥ÿ®Ÿá ÿ≥ŸÜ</button>
                    <div id="age-result" class="glass-panel rounded-xl p-4 mt-2 text-center text-gray-800 dark:text-white flex flex-col gap-2">
                        ---
                    </div>
                </div>
            `;
        }

        /**
         * Calculates and displays age using Jalali calendar
         */
        function calcAge() {
            const year = parseInt(document.getElementById('age-year').value);
            const month = parseInt(document.getElementById('age-month').value);
            const day = parseInt(document.getElementById('age-day').value);
            const resDiv = document.getElementById('age-result');

            if (!year || !month || !day) {
                resDiv.innerHTML = '<span class="text-red-600">ŸÑÿ∑ŸÅÿß ÿ™ÿßÿ±€åÿÆ ÿ™ŸàŸÑÿØ ÿ±ÿß ⁄©ÿßŸÖŸÑ Ÿàÿßÿ±ÿØ ⁄©ŸÜ€åÿØ</span>';
                return;
            }

            // Current Jalali date (approximation)
            const now = new Date();
            const gYear = now.getFullYear();
            const gMonth = now.getMonth() + 1;
            const gDay = now.getDate();
            
            // Approximate conversion: Gregorian year - 621 = Jalali year (with adjustments)
            let currentJYear = gYear - 621;
            let currentJMonth = gMonth;
            let currentJDay = gDay;
            
            // Adjust for Jalali calendar (this is simplified)
            if (gMonth <= 3) {
                currentJYear--;
                currentJMonth = gMonth + 9;
            } else {
                currentJMonth = gMonth - 3;
            }

            if (year > currentJYear || (year === currentJYear && month > currentJMonth) || 
                (year === currentJYear && month === currentJMonth && day > currentJDay)) {
                resDiv.innerHTML = '<span class="text-red-600">ÿ™ÿßÿ±€åÿÆ ÿ™ŸàŸÑÿØ ŸÜŸÖ€å‚Äåÿ™ŸàÿßŸÜÿØ ÿØÿ± ÿ¢€åŸÜÿØŸá ÿ®ÿßÿ¥ÿØ!</span>';
                return;
            }

            // Calculate age
            let ageYears = currentJYear - year;
            let ageMonths = currentJMonth - month;
            let ageDays = currentJDay - day;

            if (ageDays < 0) {
                ageMonths--;
                const daysInPrevMonth = (currentJMonth <= 6) ? 31 : (currentJMonth === 12) ? 29 : 30;
                ageDays += daysInPrevMonth;
            }

            if (ageMonths < 0) {
                ageYears--;
                ageMonths += 12;
            }

            // Approximate total days
            const totalDays = Math.floor((ageYears * 365.25) + (ageMonths * 30.44) + ageDays);
            const totalWeeks = Math.floor(totalDays / 7);
            const totalMonths = (ageYears * 12) + ageMonths;
            const totalSeconds = totalDays * 24 * 60 * 60;

            resDiv.innerHTML = `
                <div class="font-bold text-lg text-green-700 dark:text-green-400 border-b border-gray-400/30 pb-2 w-full">
                    ${ageYears} ÿ≥ÿßŸÑ Ÿà ${ageMonths} ŸÖÿßŸá Ÿà ${ageDays} ÿ±Ÿàÿ≤
                </div>
                <div class="text-sm text-gray-600 dark:text-gray-300 grid grid-cols-2 gap-2 w-full pt-2">
                    <div class="glass-panel rounded-lg p-1 bg-white/20">
                        <span class="block text-xs opacity-70">ŸÖÿßŸá (⁄©ŸÑ€å)</span>
                        <span class="font-mono font-bold">${totalMonths.toLocaleString()}</span>
                    </div>
                    <div class="glass-panel rounded-lg p-1 bg-white/20">
                        <span class="block text-xs opacity-70">ŸáŸÅÿ™Ÿá</span>
                        <span class="font-mono font-bold">${totalWeeks.toLocaleString()}</span>
                    </div>
                    <div class="glass-panel rounded-lg p-1 bg-white/20">
                        <span class="block text-xs opacity-70">ÿ±Ÿàÿ≤</span>
                        <span class="font-mono font-bold">${totalDays.toLocaleString()}</span>
                    </div>
                    <div class="glass-panel rounded-lg p-1 bg-white/20">
                        <span class="block text-xs opacity-70">ÿ´ÿßŸÜ€åŸá</span>
                        <span class="font-mono font-bold text-xs sm:text-sm">${totalSeconds.toLocaleString()}</span>
                    </div>
                </div>
            `;
        }

        /**
         * Renders discount calculator UI
         */
        function renderDiscountCalculator() {
            document.getElementById('calculations-content').innerHTML = `
                <div class="flex flex-col gap-4">
                    <input type="number" id="disc-price" class="glass-input w-full h-12 rounded-xl text-center text-lg font-mono" placeholder="ŸÇ€åŸÖÿ™ ÿßÿµŸÑ€å">
                    <input type="number" id="disc-percent" class="glass-input w-full h-12 rounded-xl text-center text-lg font-mono" placeholder="ÿØÿ±ÿµÿØ ÿ™ÿÆŸÅ€åŸÅ">
                    <button onclick="calcDiscount()" class="btn-bubble btn-eq h-12 rounded-xl text-lg font-semibold shadow-lg">ŸÖÿ≠ÿßÿ≥ÿ®Ÿá</button>
                    <div id="disc-result" class="glass-panel rounded-xl p-4 mt-2 text-center text-gray-800 dark:text-white font-mono dir-ltr">
                        ---
                    </div>
                </div>
            `;
        }

        /**
         * Calculates discount
         */
        function calcDiscount() {
            const price = parseFloat(document.getElementById('disc-price').value);
            const percent = parseFloat(document.getElementById('disc-percent').value);
            const resDiv = document.getElementById('disc-result');

            if (isNaN(price) || isNaN(percent)) {
                resDiv.innerHTML = '<span class="text-red-600">Ÿàÿ±ŸàÿØ€å ŸÜÿßŸÇÿµ</span>';
                return;
            }
            const saving = price * (percent / 100);
            const final = price - saving;
            resDiv.innerHTML = `
                <div>Ÿæÿ±ÿØÿßÿÆÿ™€å: <span class="font-bold text-xl">${final.toLocaleString()}</span></div>
                <div class="text-sm text-green-600 mt-1">ÿ≥ŸàÿØ ÿ¥ŸÖÿß: ${saving.toLocaleString()}</div>
            `;
        }

        /* ========================================
           POWER & CONVERT MODAL
           ======================================== */
        
        /**
         * Opens power & convert modal
         */
        function openPowerConvert() {
            document.getElementById('power-convert-modal').classList.add('open');
            document.getElementById('main-menu').classList.remove('show');
            setPowerConvertMode('power'); // Default to power
        }

        /**
         * Sets power/convert mode
         */
        function setPowerConvertMode(mode) {
            powerConvertMode = mode;
            
            const powerBtn = document.getElementById('btn-pc-power');
            const convertBtn = document.getElementById('btn-pc-convert');
            
            if (mode === 'power') {
                powerBtn.className = "flex-1 py-2 rounded-full text-xs font-semibold bg-white/70 dark:bg-white/20 text-gray-900 dark:text-white shadow-sm transition-all";
                convertBtn.className = "flex-1 py-2 rounded-full text-xs font-semibold text-gray-600 dark:text-gray-400 hover:bg-white/50 transition-all";
                renderPowerCalculator();
            } else {
                convertBtn.className = "flex-1 py-2 rounded-full text-xs font-semibold bg-white/70 dark:bg-white/20 text-gray-900 dark:text-white shadow-sm transition-all";
                powerBtn.className = "flex-1 py-2 rounded-full text-xs font-semibold text-gray-600 dark:text-gray-400 hover:bg-white/50 transition-all";
                renderUnitConverter();
            }
        }

        /**
         * Renders power calculator UI
         */
        function renderPowerCalculator() {
            document.getElementById('power-convert-content').innerHTML = `
                <div class="flex flex-col gap-6">
                    <div class="flex flex-col gap-2">
                        <label class="text-sm font-semibold text-gray-700 dark:text-gray-300">ÿ®Ÿá ÿ™ŸàÿßŸÜ ÿ±ÿ≥ÿßŸÜÿØŸÜ (x<sup>y</sup>)</label>
                        <div class="flex gap-2">
                            <input type="number" id="pow-base" class="glass-input w-full h-10 rounded-xl text-center font-mono" placeholder="Ÿæÿß€åŸá (x)">
                            <input type="number" id="pow-exp" class="glass-input w-full h-10 rounded-xl text-center font-mono" placeholder="ÿ™ŸàÿßŸÜ (y)">
                        </div>
                        <button onclick="calcPower()" class="btn-bubble btn-op h-10 rounded-xl">ŸÖÿ≠ÿßÿ≥ÿ®Ÿá ÿ™ŸàÿßŸÜ</button>
                        <div id="pow-result" class="text-center font-bold text-lg font-mono text-gray-800 dark:text-white">---</div>
                    </div>
                </div>
            `;
        }

        /**
         * Calculates power
         */
        function calcPower() {
            const base = parseFloat(document.getElementById('pow-base').value);
            const exp = parseFloat(document.getElementById('pow-exp').value);
            if (isNaN(base) || isNaN(exp)) return;
            document.getElementById('pow-result').innerText = Math.pow(base, exp);
        }

        /**
         * Unit conversion data
         */
        const unitData = {
            length: [
                { val: 'm', label: 'ŸÖÿ™ÿ± (m)', factor: 1 },
                { val: 'cm', label: 'ÿ≥ÿßŸÜÿ™€å‚ÄåŸÖÿ™ÿ± (cm)', factor: 0.01 },
                { val: 'km', label: '⁄©€åŸÑŸàŸÖÿ™ÿ± (km)', factor: 1000 },
                { val: 'inch', label: 'ÿß€åŸÜ⁄Ü (in)', factor: 0.0254 },
                { val: 'ft', label: 'ŸÅŸàÿ™ (ft)', factor: 0.3048 }
            ],
            mass: [
                { val: 'kg', label: '⁄©€åŸÑŸà⁄Øÿ±ŸÖ (kg)', factor: 1000 },
                { val: 'g', label: '⁄Øÿ±ŸÖ (g)', factor: 1 },
                { val: 'lb', label: 'ŸæŸàŸÜÿØ (lb)', factor: 453.592 },
                { val: 'mesghal', label: 'ŸÖÿ´ŸÇÿßŸÑ', factor: 4.6083 },
                { val: 'soot', label: 'ÿ≥Ÿàÿ™', factor: 0.001 }
            ],
            temp: [
                { val: 'c', label: 'ÿ≥ŸÑÿ≥€åŸàÿ≥ (¬∞C)' },
                { val: 'f', label: 'ŸÅÿßÿ±ŸÜŸáÿß€åÿ™ (¬∞F)' }
            ],
            currency: [
                { val: 'usd', label: 'ÿØŸÑÿßÿ± (USD)' },
                { val: 'irr', label: 'ÿ™ŸàŸÖÿßŸÜ (IRR)' }
            ]
        };

        /**
         * Renders unit converter UI
         */
        function renderUnitConverter() {
            document.getElementById('power-convert-content').innerHTML = `
                <div class="flex flex-col gap-4">
                    <div>
                        <label class="text-sm text-gray-600 dark:text-gray-300 font-semibold mb-1 block">ŸÜŸàÿπ Ÿàÿßÿ≠ÿØ:</label>
                        <select id="conv-type" onchange="updateConvOptions()" class="glass-input w-full h-10 rounded-xl text-center appearance-none cursor-pointer">
                            <option value="length">ÿ∑ŸàŸÑ</option>
                            <option value="mass">Ÿàÿ≤ŸÜ (ÿ¨ÿ±ŸÖ)</option>
                            <option value="temp">ÿØŸÖÿß</option>
                            <option value="currency">ÿßÿ±ÿ≤ (ÿØŸÑÿßÿ± ‚Üî ÿ™ŸàŸÖÿßŸÜ)</option>
                        </select>
                    </div>

                    <div id="currency-rate-section" class="hidden">
                        <label class="text-sm text-gray-600 dark:text-gray-300 font-semibold mb-1 block">ŸÇ€åŸÖÿ™ €± ÿØŸÑÿßÿ± (ÿ®Ÿá ÿ™ŸàŸÖÿßŸÜ):</label>
                        <input type="number" id="currency-rate-input" class="glass-input w-full h-10 rounded-xl text-center font-mono text-gray-700" placeholder="700000" value="700000">
                    </div>

                    <div>
                        <label class="text-sm text-gray-600 dark:text-gray-300 font-semibold mb-1 block">ŸÖŸÇÿØÿßÿ±:</label>
                        <input type="number" id="conv-input" oninput="convertUnits()" class="glass-input w-full h-12 text-xl text-center rounded-xl font-mono text-gray-800" placeholder="0">
                    </div>

                    <div class="flex gap-2 items-center">
                        <select id="conv-from" onchange="convertUnits()" class="glass-input flex-1 h-12 rounded-xl text-center appearance-none cursor-pointer"></select>
                        <span class="text-gray-500 font-bold dark:text-gray-300">ÿ®Ÿá</span>
                        <select id="conv-to" onchange="convertUnits()" class="glass-input flex-1 h-12 rounded-xl text-center appearance-none cursor-pointer"></select>
                    </div>

                    <div class="glass-panel rounded-xl p-4 mt-2 text-center">
                        <div class="text-sm text-gray-500 dark:text-gray-400 mb-1">ŸÜÿ™€åÿ¨Ÿá:</div>
                        <div id="conv-result" class="text-2xl font-mono font-bold text-gray-800 dark:text-white">0</div>
                    </div>
                </div>
            `;
            updateConvOptions();
        }

        /**
         * Updates conversion unit options
         */
        function updateConvOptions() {
            const typeSelect = document.getElementById('conv-type');
            if (!typeSelect) return;
            
            const type = typeSelect.value;
            const fromSelect = document.getElementById('conv-from');
            const toSelect = document.getElementById('conv-to');
            const rateSection = document.getElementById('currency-rate-section');

            if (!fromSelect || !toSelect) return;

            if (type === 'currency') {
                rateSection.classList.remove('hidden');
            } else {
                rateSection.classList.add('hidden');
            }

            const data = unitData[type];

            fromSelect.innerHTML = '';
            toSelect.innerHTML = '';

            data.forEach((unit) => {
                const opt1 = document.createElement('option');
                opt1.value = unit.val;
                opt1.text = unit.label;
                fromSelect.add(opt1);

                const opt2 = document.createElement('option');
                opt2.value = unit.val;
                opt2.text = unit.label;
                toSelect.add(opt2);
            });

            if (toSelect.options.length > 1) toSelect.selectedIndex = 1;
            convertUnits();
        }

        /**
         * Converts units based on selected type
         */
        function convertUnits() {
            const valInput = document.getElementById('conv-input');
            const typeSelect = document.getElementById('conv-type');
            const fromSelect = document.getElementById('conv-from');
            const toSelect = document.getElementById('conv-to');
            const resDiv = document.getElementById('conv-result');

            if (!valInput || !typeSelect || !fromSelect || !toSelect || !resDiv) return;

            const val = parseFloat(valInput.value);
            const type = typeSelect.value;
            const from = fromSelect.value;
            const to = toSelect.value;

            if (isNaN(val)) {
                resDiv.innerText = '0';
                return;
            }

            let result;

            if (type === 'currency') {
                const rateInput = document.getElementById('currency-rate-input');
                const rate = parseFloat(rateInput.value) || 700000;
                if (from === to) {
                    result = val;
                } else if (from === 'usd' && to === 'irr') {
                    result = val * rate;
                } else if (from === 'irr' && to === 'usd') {
                    result = val / rate;
                }
            } else if (type === 'temp') {
                if (from === to) result = val;
                else if (from === 'c' && to === 'f') result = (val * 9/5) + 32;
                else if (from === 'f' && to === 'c') result = (val - 32) * 5/9;
            } else {
                const data = unitData[type];
                const fromUnit = data.find(u => u.val === from);
                const toUnit = data.find(u => u.val === to);
                if (!fromUnit || !toUnit) return;
                const baseValue = val * fromUnit.factor;
                result = baseValue / toUnit.factor;
            }

            let finalRes;
            if (Math.abs(result) < 0.000001 && result !== 0 || Math.abs(result) > 1000000) {
                finalRes = result.toExponential(4);
            } else {
                finalRes = parseFloat(result.toFixed(4));
            }
            resDiv.innerText = finalRes.toLocaleString();
        }

        /* ========================================
           BMI CALCULATOR
           ======================================== */
        
        /**
         * Opens BMI calculator modal
         */
        function openBMI() {
            document.getElementById('bmi-modal').classList.add('open');
            document.getElementById('main-menu').classList.remove('show');
        }

        /**
         * Calculates BMI with weight difference
         */
        function calcBMI() {
            const h = parseFloat(document.getElementById('bmi-height').value) / 100;
            const w = parseFloat(document.getElementById('bmi-weight').value);
            const resDiv = document.getElementById('bmi-result');

            if (isNaN(h) || isNaN(w) || h <= 0) {
                resDiv.innerHTML = '<span class="text-red-600">Ÿàÿ±ŸàÿØ€å ŸÜÿßŸÖÿπÿ™ÿ®ÿ±</span>';
                return;
            }

            const bmi = w / (h * h);
            let status = '';
            let color = '';
            let weightDiff = '';

            // Calculate ideal weight range (BMI 18.5-25)
            const idealMinWeight = 18.5 * h * h;
            const idealMaxWeight = 25 * h * h;

            if(bmi < 18.5) { 
                status = '⁄©ŸÖÿ®ŸàÿØ Ÿàÿ≤ŸÜ'; 
                color = 'text-blue-600';
                const deficit = idealMinWeight - w;
                weightDiff = `<div class="text-sm text-blue-600 mt-2">ÿ¥ŸÖÿß ${deficit.toFixed(1)} ⁄©€åŸÑŸà⁄Øÿ±ŸÖ ⁄©ŸÖÿ®ŸàÿØ Ÿàÿ≤ŸÜ ÿØÿßÿ±€åÿØ</div>`;
            }
            else if(bmi < 25) { 
                status = 'ŸÜÿ±ŸÖÿßŸÑ'; 
                color = 'text-green-600';
                weightDiff = '<div class="text-sm text-green-600 mt-2">Ÿàÿ≤ŸÜ ÿ¥ŸÖÿß ÿØÿ± ŸÖÿ≠ÿØŸàÿØŸá ÿ∑ÿ®€åÿπ€å ÿßÿ≥ÿ™ ‚úì</div>';
            }
            else if(bmi < 30) { 
                status = 'ÿßÿ∂ÿßŸÅŸá Ÿàÿ≤ŸÜ'; 
                color = 'text-orange-600';
                const excess = w - idealMaxWeight;
                weightDiff = `<div class="text-sm text-orange-600 mt-2">${excess.toFixed(1)} ⁄©€åŸÑŸà⁄Øÿ±ŸÖ ÿßÿ∂ÿßŸÅŸá Ÿàÿ≤ŸÜ ÿØÿßÿ±€åÿØ</div>`;
            }
            else { 
                status = '⁄ÜÿßŸÇ'; 
                color = 'text-red-600';
                const excess = w - idealMaxWeight;
                weightDiff = `<div class="text-sm text-red-600 mt-2">${excess.toFixed(1)} ⁄©€åŸÑŸà⁄Øÿ±ŸÖ ÿßÿ∂ÿßŸÅŸá Ÿàÿ≤ŸÜ ÿØÿßÿ±€åÿØ</div>`;
            }

            resDiv.innerHTML = `
                <div class="text-3xl font-bold mb-1">${bmi.toFixed(1)}</div>
                <div class="text-lg font-bold ${color}">${status}</div>
                ${weightDiff}
                <div class="text-xs text-gray-500 mt-3 pt-2 border-t border-gray-300/30">
                    Ÿàÿ≤ŸÜ ÿß€åÿØŸá‚Äåÿ¢ŸÑ: ${idealMinWeight.toFixed(1)} - ${idealMaxWeight.toFixed(1)} ⁄©€åŸÑŸà⁄Øÿ±ŸÖ
                </div>
            `;
        }

        /* ========================================
           BLACKBOARD FUNCTIONS
           ======================================== */
        
        /**
         * Initializes blackboard canvas
         */
        function initBlackboard() {
            blackboardCanvas = document.getElementById('blackboard-canvas');
            blackboardCtx = blackboardCanvas.getContext('2d');

            // Brush size control
            document.getElementById('brush-size').addEventListener('input', (e) => {
                brushSize = parseInt(e.target.value);
            });

            // Set canvas size
            function resizeCanvas() {
                const container = document.getElementById('blackboard-border');
                blackboardCanvas.width = container.clientWidth;
                blackboardCanvas.height = container.clientHeight;
                blackboardCtx.fillStyle = '#0a0a0a';
                blackboardCtx.fillRect(0, 0, blackboardCanvas.width, blackboardCanvas.height);
            }
            
            setTimeout(resizeCanvas, 100);
            window.addEventListener('resize', resizeCanvas);

            // Color buttons
            document.querySelectorAll('.color-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentColor = this.dataset.color;
                    isEraser = false;
                });
            });

            // Drawing events
            blackboardCanvas.addEventListener('mousedown', startDrawing);
            blackboardCanvas.addEventListener('mousemove', draw);
            blackboardCanvas.addEventListener('mouseup', stopDrawing);
            blackboardCanvas.addEventListener('mouseout', stopDrawing);

            blackboardCanvas.addEventListener('touchstart', handleTouchStart);
            blackboardCanvas.addEventListener('touchmove', handleTouchMove);
            blackboardCanvas.addEventListener('touchend', stopDrawing);
        }

        /**
         * Starts drawing on blackboard
         */
        function startDrawing(e) {
            isDrawing = true;
            const rect = blackboardCanvas.getBoundingClientRect();
            lastX = e.clientX - rect.left;
            lastY = e.clientY - rect.top;
        }

        /**
         * Draws on blackboard
         */
        function draw(e) {
            if (!isDrawing) return;
            
            const rect = blackboardCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            blackboardCtx.beginPath();
            blackboardCtx.moveTo(lastX, lastY);
            blackboardCtx.lineTo(x, y);
            blackboardCtx.strokeStyle = isEraser ? '#0a0a0a' : currentColor;
            blackboardCtx.lineWidth = brushSize;
            blackboardCtx.lineCap = 'round';
            blackboardCtx.lineJoin = 'round';
            blackboardCtx.stroke();

            lastX = x;
            lastY = y;
        }

        /**
         * Handles touch start for mobile
         */
        function handleTouchStart(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const rect = blackboardCanvas.getBoundingClientRect();
            isDrawing = true;
            lastX = touch.clientX - rect.left;
            lastY = touch.clientY - rect.top;
        }

        /**
         * Handles touch move for mobile
         */
        function handleTouchMove(e) {
            e.preventDefault();
            if (!isDrawing) return;
            
            const touch = e.touches[0];
            const rect = blackboardCanvas.getBoundingClientRect();
            const x = touch.clientX - rect.left;
            const y = touch.clientY - rect.top;

            blackboardCtx.beginPath();
            blackboardCtx.moveTo(lastX, lastY);
            blackboardCtx.lineTo(x, y);
            blackboardCtx.strokeStyle = isEraser ? '#0a0a0a' : currentColor;
            blackboardCtx.lineWidth = brushSize;
            blackboardCtx.lineCap = 'round';
            blackboardCtx.lineJoin = 'round';
            blackboardCtx.stroke();

            lastX = x;
            lastY = y;
        }

        /**
         * Stops drawing
         */
        function stopDrawing() {
            isDrawing = false;
        }

        /**
         * Toggles eraser mode
         */
        function toggleEraser() {
            isEraser = !isEraser;
            if (isEraser) {
                document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active'));
            }
        }

        /**
         * Clears blackboard
         */
        function clearBlackboard() {
            blackboardCtx.fillStyle = '#0a0a0a';
            blackboardCtx.fillRect(0, 0, blackboardCanvas.width, blackboardCanvas.height);
        }

        /**
         * Opens blackboard
         */
        function openBlackboard() {
            const overlay = document.getElementById('blackboard-overlay');
            overlay.style.opacity = '0';
            overlay.classList.add('active');
            
            document.getElementById('main-menu').classList.remove('show');
            
            requestAnimationFrame(() => {
                overlay.style.opacity = '1';
            });
            
            setTimeout(() => {
                const container = document.getElementById('blackboard-border');
                blackboardCanvas.width = container.clientWidth;
                blackboardCanvas.height = container.clientHeight;
                clearBlackboard();
            }, 100);
        }

        /**
         * Closes blackboard
         */
        function closeBlackboard() {
            const overlay = document.getElementById('blackboard-overlay');
            overlay.style.opacity = '0';
            
            setTimeout(() => {
                overlay.classList.remove('active');
                overlay.style.opacity = '1';
            }, 800);
        }

        /* ========================================
           TAB SWITCHING
           ======================================== */
        
        /**
         * Switches between calculator tabs
         */
        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.nav-pill').forEach(btn => {
                btn.classList.remove('active');
                if(btn.id === `tab-${tab}`) btn.classList.add('active');
            });

            const content = document.getElementById('app-content');
            content.style.opacity = '0';
            setTimeout(() => {
                content.innerHTML = '';
                if(tab === 'basic') { displayVal = '0'; renderBasic(); }
                else if(tab === 'pythagoras') renderPythagoras();
                else if(tab === 'fraction') renderFraction();
                else if(tab === 'factorize') renderFactorize();
                else if(tab === 'equation') renderEquation();
                else if(tab === 'properties') renderProperties();
                else if(tab === 'sieve') renderSieve();
                else if(tab === 'metals') renderMetals();
                content.style.opacity = '1';
            }, 150);
        }

        /* ========================================
           BASIC CALCULATOR
           ======================================== */
        
        /**
         * Renders basic calculator UI
         */
        function renderBasic() {
            const container = document.getElementById('app-content');
            container.innerHTML = `
                <div class="flex flex-col h-full justify-end">
                    <div class="glass-panel rounded-[2rem] p-5 mb-5 text-right flex flex-col justify-center min-h-[5rem] shadow-inner border-2">
                        <span class="text-3xl sm:text-4xl font-mono font-semibold text-gray-800 dark:text-gray-100 break-all tracking-tight" id="calc-display">${displayVal}</span>
                    </div>

                    <div class="grid grid-cols-4 gap-2.5 sm:gap-3">
                        <button onclick="inputParen('(')" class="btn-bubble btn-func h-14 sm:h-16 w-full rounded-full font-semibold flex items-center justify-center shadow-lg">(</button>
                        <button onclick="inputParen(')')" class="btn-bubble btn-func h-14 sm:h-16 w-full rounded-full font-semibold flex items-center justify-center shadow-lg">)</button>
                        <button onclick="handlePercent()" class="btn-bubble btn-func h-14 sm:h-16 w-full rounded-full font-semibold flex items-center justify-center shadow-lg">%</button>
                        <button onclick="handleSqrt()" class="btn-bubble btn-func h-14 sm:h-16 w-full rounded-full font-semibold flex items-center justify-center shadow-lg">‚àö</button>

                        <button onclick="handleClear()" class="btn-bubble btn-ac h-14 sm:h-16 w-full rounded-full font-semibold text-lg flex items-center justify-center shadow-lg">AC</button>
                        <button onclick="handleOp('/')" class="btn-bubble btn-op h-14 sm:h-16 w-full rounded-full font-semibold text-xl flex items-center justify-center shadow-lg">√∑</button>
                        <button onclick="handleOp('*')" class="btn-bubble btn-op h-14 sm:h-16 w-full rounded-full font-semibold text-xl flex items-center justify-center shadow-lg">√ó</button>
                        <button onclick="handleOp('-')" class="btn-bubble btn-op h-14 sm:h-16 w-full rounded-full font-semibold text-xl flex items-center justify-center shadow-lg">-</button>

                        <button onclick="inputDigit(7)" class="btn-bubble h-14 sm:h-16 w-full rounded-full font-medium text-2xl text-gray-600 flex items-center justify-center">7</button>
                        <button onclick="inputDigit(8)" class="btn-bubble h-14 sm:h-16 w-full rounded-full font-medium text-2xl text-gray-600 flex items-center justify-center">8</button>
                        <button onclick="inputDigit(9)" class="btn-bubble h-14 sm:h-16 w-full rounded-full font-medium text-2xl text-gray-600 flex items-centerjustify-center">9</button>
                        <button onclick="handleOp('+')" class="btn-bubble btn-op h-14 sm:h-16 w-full rounded-full font-semibold text-xl flex items-center justify-center shadow-lg">+</button>

                        <button onclick="inputDigit(4)" class="btn-bubble h-14 sm:h-16 w-full rounded-full font-medium text-2xl text-gray-600 flex items-center justify-center">4</button>
                        <button onclick="inputDigit(5)" class="btn-bubble h-14 sm:h-16 w-full rounded-full font-medium text-2xl text-gray-600 flex items-center justify-center">5</button>
                        <button onclick="inputDigit(6)" class="btn-bubble h-14 sm:h-16 w-full rounded-full font-medium text-2xl text-gray-600 flex items-center justify-center">6</button>
                        <button onclick="handleEqual()" class="btn-bubble btn-eq rounded-[2rem] font-semibold text-3xl row-span-2 shadow-glow flex items-center justify-center">=</button>

                        <button onclick="inputDigit(1)" class="btn-bubble h-14 sm:h-16 w-full rounded-full font-medium text-2xl text-gray-600 flex items-center justify-center">1</button>
                        <button onclick="inputDigit(2)" class="btn-bubble h-14 sm:h-16 w-full rounded-full font-medium text-2xl text-gray-600 flex items-center justify-center">2</button>
                        <button onclick="inputDigit(3)" class="btn-bubble h-14 sm:h-16 w-full rounded-full font-medium text-2xl text-gray-600 flex items-center justify-center">3</button>

                        <button onclick="inputDigit(0)" class="btn-bubble w-full col-span-2 rounded-full font-medium text-2xl text-gray-600 flex items-center justify-center h-14 sm:h-16">0</button>
                        <button onclick="inputDot()" class="btn-bubble h-14 sm:h-16 w-full rounded-full font-semibold text-2xl text-gray-600 flex items-center justify-center">.</button>
                    </div>
                </div>
            `;
        }

        /**
         * Updates calculator display
         */
        function updateDisplay() {
            const display = document.getElementById('calc-display');
            if(display) display.innerText = displayVal;
        }

        /**
         * Inputs a digit
         */
        function inputDigit(digit) {
            if(displayVal === '0' || displayVal === 'Error') {
                displayVal = String(digit);
            } else {
                displayVal += digit;
            }
            updateDisplay();
        }

        /**
         * Inputs decimal point
         */
        function inputDot() {
            if (displayVal.slice(-1) !== '.') {
                displayVal += '.';
                updateDisplay();
            }
        }

        /**
         * Inputs parenthesis
         */
        function inputParen(paren) {
            if(displayVal === '0' && paren === '(') {
                displayVal = '(';
            } else if (displayVal === 'Error') {
                displayVal = paren;
            } else {
                displayVal += paren;
            }
            updateDisplay();
        }

        /**
         * Handles operator input
         */
        function handleOp(op) {
            if(displayVal === 'Error') displayVal = '0';
            const lastChar = displayVal.slice(-1);
            if (['+', '-', '*', '/'].includes(lastChar)) {
                displayVal = displayVal.slice(0, -1) + op;
            } else {
                displayVal += op;
            }
            updateDisplay();
        }

        /**
         * Clears display
         */
        function handleClear() {
            displayVal = '0';
            updateDisplay();
        }

        /**
         * Calculates square root
         */
        function handleSqrt() {
            try {
                const val = eval(displayVal);
                if (val < 0) {
                    displayVal = 'Error';
                } else {
                    const res = Math.sqrt(val);
                    const resStr = String(parseFloat(res.toFixed(8)));
                    addToHistory(`‚àö(${displayVal})`, resStr);
                    displayVal = resStr;
                }
            } catch (e) {
                displayVal = 'Error';
            }
            updateDisplay();
        }

        /**
         * Calculates percentage
         */
        function handlePercent() {
            try {
                const val = eval(displayVal);
                const res = val / 100;
                const resStr = String(parseFloat(res.toFixed(8)));
                addToHistory(`${displayVal}%`, resStr); 
                displayVal = resStr;
            } catch (e) {
                displayVal = 'Error';
            }
            updateDisplay();
        }

        /**
         * Calculates result
         */
        function handleEqual() {
            if (displayVal === '1391') {
                document.body.classList.toggle('easter-egg-active');
                showToast('üéâ Easter Egg Found! üéâ');
                displayVal = '0';
                updateDisplay();
                return;
            }

            try {
                const prevExpr = displayVal;
                const result = new Function('return ' + displayVal)();
                if(!isFinite(result) || isNaN(result)) {
                     displayVal = 'Error';
                } else {
                     const resStr = String(parseFloat(result.toFixed(8)));
                     addToHistory(prevExpr, resStr);
                     displayVal = resStr;
                }
            } catch (e) {
                displayVal = 'Error';
            }
            updateDisplay();
        }

        /* ========================================
           PYTHAGORAS CALCULATOR
           ======================================== */
        
        /**
         * Renders Pythagoras calculator
         */
        function renderPythagoras() {
            const container = document.getElementById('app-content');
            container.innerHTML = `
                <div class="flex flex-col gap-6 items-center pt-4">
                    <h3 class="text-gray-700 dark:text-gray-300 font-semibold text-lg">ŸÇÿ∂€åŸá ŸÅ€åÿ´ÿßÿ∫Ÿàÿ±ÿ≥</h3>
                    
                    <!-- Triangle visualization -->
                    <div class="glass-panel w-full rounded-2xl p-6 flex items-center justify-center border-2" style="min-height: 220px;">
                        <svg width="100%" height="200" viewBox="0 0 200 180" class="max-w-xs">
                            <!-- Right triangle -->
                            <line x1="40" y1="150" x2="160" y2="150" stroke="#4f46e5" stroke-width="3"/>
                            <line x1="160" y1="150" x2="160" y2="30" stroke="#4f46e5" stroke-width="3"/>
                            <line x1="40" y1="150" x2="160" y2="30" stroke="#e11d48" stroke-width="3"/>
                            
                            <!-- Right angle marker -->
                            <rect x="150" y="140" width="10" height="10" fill="none" stroke="#4f46e5" stroke-width="2"/>
                            
                            <!-- Small squares -->
                            <rect x="100" y="145" width="30" height="30" fill="rgba(79, 70, 229, 0.15)" stroke="#4f46e5" stroke-width="2" stroke-dasharray="3,3"/>
                            <rect x="155" y="70" width="30" height="30" fill="rgba(79, 70, 229, 0.15)" stroke="#4f46e5" stroke-width="2" stroke-dasharray="3,3"/>
                            <rect x="80" y="65" width="50" height="50" fill="rgba(225, 29, 72, 0.15)" stroke="#e11d48" stroke-width="2" stroke-dasharray="3,3"/>
                            
                            <!-- Labels -->
                            <text x="100" y="170" fill="#4f46e5" font-size="16" font-weight="bold" text-anchor="middle">a</text>
                            <text x="175" y="90" fill="#4f46e5" font-size="16" font-weight="bold">b</text>
                            <text x="90" y="75" fill="#e11d48" font-size="16" font-weight="bold">c</text>
                        </svg>
                    </div>

                    <div class="glass-panel w-full p-6 rounded-[2.5rem] flex flex-col gap-4 border-2">
                        <div class="flex gap-3 items-center justify-center">
                            <input type="number" id="pyth-a" class="glass-input w-20 h-12 rounded-xl text-center font-mono" placeholder="a">
                            <input type="number" id="pyth-b" class="glass-input w-20 h-12 rounded-xl text-center font-mono" placeholder="b">
                        </div>
                        <p class="text-xs text-gray-500 text-center">ÿØŸà ÿ∂ŸÑÿπ ⁄©ŸÜÿßÿ± ÿ≤ÿßŸà€åŸá ŸÇÿßÿ¶ŸÖŸá ÿ±ÿß Ÿàÿßÿ±ÿØ ⁄©ŸÜ€åÿØ</p>
                        <button onclick="calcPythagoras()" class="btn-bubble btn-eq h-12 rounded-xl text-lg font-semibold">ŸÖÿ≠ÿßÿ≥ÿ®Ÿá Ÿàÿ™ÿ± (c)</button>
                    </div>

                    <div id="pyth-result" class="glass-panel w-full min-h-[6rem] rounded-[2rem] flex flex-col items-center justify-center p-4 text-center border-2">
                        <span class="text-gray-500 dark:text-gray-300 text-sm">ŸÖŸÜÿ™ÿ∏ÿ± Ÿàÿ±ŸàÿØ€å...</span>
                    </div>
                </div>
            `;
        }

        /**
         * Calculates Pythagoras theorem
         */
        function calcPythagoras() {
            const a = parseFloat(document.getElementById('pyth-a').value);
            const b = parseFloat(document.getElementById('pyth-b').value);
            const resDiv = document.getElementById('pyth-result');

            if (isNaN(a) || isNaN(b) || a <= 0 || b <= 0) {
                resDiv.innerHTML = '<span class="text-red-600 font-bold">ŸÑÿ∑ŸÅÿßŸã ŸÖŸÇÿßÿØ€åÿ± ŸÖÿπÿ™ÿ®ÿ± Ÿàÿßÿ±ÿØ ⁄©ŸÜ€åÿØ</span>';
                return;
            }

            const cSquared = a*a + b*b;
            const c = Math.sqrt(cSquared);
            
            // Check if c is a perfect square
            const isWholeNumber = Math.abs(c - Math.round(c)) < 0.0001;

            let resultHTML = '<div class="flex flex-col gap-3 w-full">';
            resultHTML += '<div class="text-lg font-bold text-gray-800 dark:text-white border-b border-gray-400/30 pb-2">ŸÜÿ™€åÿ¨Ÿá:</div>';
            
            if (isWholeNumber) {
                resultHTML += `<div class="text-3xl font-mono font-bold text-green-700 dark:text-green-400">c = ${Math.round(c)}</div>`;
                resultHTML += `<div class="text-sm text-gray-600 dark:text-gray-400 mt-2">Ÿàÿ™ÿ± €å⁄© ÿπÿØÿØ ÿµÿ≠€åÿ≠ ÿßÿ≥ÿ™! ‚úì</div>`;
            } else {
                // Show both radical and decimal form
                resultHTML += `<div class="text-2xl font-mono font-bold text-blue-700 dark:text-blue-400" dir="ltr">c = ‚àö${cSquared}</div>`;
                resultHTML += `<div class="text-lg font-mono text-gray-600 dark:text-gray-300 mt-1">c ‚âà ${c.toFixed(3)}</div>`;
                resultHTML += `<div class="text-xs text-gray-500 dark:text-gray-400 mt-2">ŸÅÿ±ŸÖ ÿØŸÇ€åŸÇ: ÿ±€åÿ¥Ÿá ${cSquared}</div>`;
            }
            
            resultHTML += '</div>';
            resDiv.innerHTML = resultHTML;
        }

        /* ========================================
           FRACTION CALCULATOR
           ======================================== */
        
        /**
         * Renders fraction calculator
         */
        function renderFraction() {
            document.getElementById('app-content').innerHTML = `
                <div class="flex flex-col gap-6 items-center pt-4">
                    <h3 class="text-gray-700 dark:text-gray-300 font-semibold text-lg opacity-80">ŸÖÿ≠ÿßÿ≥ÿ®Ÿá ⁄©ÿ≥ÿ± Ÿæ€åÿ¥ÿ±ŸÅÿ™Ÿá</h3>
                    
                    <div class="glass-panel w-full rounded-[2.5rem] p-6 flex flex-col items-center gap-4 relative border-2">
                        <div class="flex items-center justify-center gap-3 w-full" dir="ltr">
                            <div class="flex flex-col items-center gap-2 w-20">
                                <input type="number" id="n1" class="glass-input w-full h-12 rounded-2xl text-center text-xl font-mono placeholder-gray-500" placeholder="a">
                                <div class="w-full h-px bg-gray-500/50 my-1"></div>
                                <input type="number" id="d1" class="glass-input w-full h-12 rounded-2xl text-center text-xl font-mono placeholder-gray-500" placeholder="b">
                            </div>

                            <div class="relative group">
                                <select id="frac-op" class="appearance-none bg-white/70 border-2 border-gray-300 text-gray-800 text-2xl font-bold rounded-full w-14 h-14 text-center cursor-pointer hover:bg-white/90 transition-all focus:outline-none focus:ring-2 focus:ring-blue-400 dark:bg-white/10 dark:text-gray-200 backdrop-blur-md">
                                    <option value="+">+</option>
                                    <option value="-">-</option>
                                    <option value="*">√ó</option>
                                    <option value="/">√∑</option>
                                </select>
                            </div>

                            <div class="flex flex-col items-center gap-2 w-20">
                                <input type="number" id="n2" class="glass-input w-full h-12 rounded-2xl text-center text-xl font-mono placeholder-gray-500" placeholder="c">
                                <div class="w-full h-px bg-gray-500/50 my-1"></div>
                                <input type="number" id="d2" class="glass-input w-full h-12 rounded-2xl text-center text-xl font-mono placeholder-gray-500" placeholder="d">
                            </div>
                        </div>

                        <button onclick="calcFraction()" class="btn-bubble btn-eq w-full h-14 rounded-full text-xl font-semibold mt-2 shadow-lg">
                            ŸÖÿ≠ÿßÿ≥ÿ®Ÿá ŸÜÿ™€åÿ¨Ÿá
                        </button>
                    </div>

                    <div id="frac-result" class="glass-panel w-full min-h-[8rem] rounded-[2.5rem] flex items-center justify-center p-4 border-2">
                        <span class="text-gray-500 dark:text-gray-300 text-sm">ÿßÿπÿØÿßÿØ ÿ±ÿß Ÿàÿßÿ±ÿØ ⁄©ŸÜ€åÿØ...</span>
                    </div>
                </div>
            `;
        }

        /**
         * Calculates fraction result
         */
        function calcFraction() {
            const n1 = parseFloat(document.getElementById('n1').value);
            const d1 = parseFloat(document.getElementById('d1').value);
            const n2 = parseFloat(document.getElementById('n2').value);
            const d2 = parseFloat(document.getElementById('d2').value);
            const op = document.getElementById('frac-op').value;
            const resBox = document.getElementById('frac-result');

            if (isNaN(n1) || isNaN(d1) || isNaN(n2) || isNaN(d2)) {
                resBox.innerHTML = '<span class="text-red-700 font-bold">ŸÑÿ∑ŸÅÿßŸã ÿ™ŸÖÿßŸÖ ÿÆÿßŸÜŸá‚ÄåŸáÿß ÿ±ÿß Ÿæÿ± ⁄©ŸÜ€åÿØ</span>';
                return;
            }
            if (d1 === 0 || d2 === 0) {
                resBox.innerHTML = '<span class="text-red-700 font-bold">ŸÖÿÆÿ±ÿ¨ ŸÜŸÖ€å‚Äåÿ™ŸàÿßŸÜÿØ ÿµŸÅÿ± ÿ®ÿßÿ¥ÿØ!</span>';
                return;
            }

            let resN, resD;

            if (op === '+') {
                resN = (n1 * d2) + (n2 * d1);
                resD = d1 * d2;
            } else if (op === '-') {
                resN = (n1 * d2) - (n2 * d1);
                resD = d1 * d2;
            } else if (op === '*') {
                resN = n1 * n2;
                resD = d1 * d2;
            } else if (op === '/') {
                if(n2 === 0) {
                    resBox.innerHTML = '<span class="text-red-700 font-bold">ÿ™ŸÇÿ≥€åŸÖ ÿ®ÿ± ÿµŸÅÿ±!</span>';
                    return;
                }
                resN = n1 * d2;
                resD = d1 * n2;
            }

            const common = gcd(Math.abs(resN), Math.abs(resD));
            const finalN = resN / common;
            const finalD = resD / common;

            let html = '';

            if (finalD === 1) {
                 html = `<span class="text-5xl font-mono font-bold text-gray-800 dark:text-white drop-shadow-sm">${finalN}</span>`;
            } else if (finalD === -1) {
                 html = `<span class="text-5xl font-mono font-bold text-gray-800 dark:text-white drop-shadow-sm">${-finalN}</span>`;
            } else {
                let showN = finalN, showD = finalD;
                if (showD < 0) { showN = -showN; showD = -showD; }

                html = `
                    <div class="flex flex-col items-center">
                        <span class="text-3xl font-mono font-bold text-gray-800 dark:text-white px-4">${showN}</span>
                        <div class="w-full h-0.5 bg-gray-600 rounded-full my-1"></div>
                        <span class="text-3xl font-mono font-bold text-gray-800 dark:text-white px-4">${showD}</span>
                    </div>
                `;
            }

            resBox.innerHTML = html;
        }

        /* ========================================
           FACTORIZE SECTION - ADVANCED WITH POWER INPUTS
           ======================================== */
        
        /**
         * Renders factorize UI
         */
        function renderFactorize() {
            document.getElementById('app-content').innerHTML = `
                 <div class="flex flex-col gap-4 pt-2">
                    <div class="glass-panel p-1.5 rounded-full flex gap-1 overflow-x-auto border-2">
                         <button onclick="setFactorizeSubTab('algebraic')" id="btn-fact-algebraic" class="flex-1 whitespace-nowrap px-3 py-2 rounded-full text-xs font-semibold bg-white/70 text-gray-900 shadow-sm transition-all">ÿ™ÿ¨ÿ≤€åŸá ÿ¨ÿ®ÿ±€å</button>
                         <button onclick="setFactorizeSubTab('fraction')" id="btn-fact-fraction" class="flex-1 whitespace-nowrap px-3 py-2 rounded-full text-xs font-semibold text-gray-600 dark:text-gray-300 hover:bg-white/50 transition-all">ÿ™ÿ¨ÿ≤€åŸá ⁄©ÿ≥ÿ±€å</button>
                    </div>

                    <div id="factorize-inputs" class="glass-panel rounded-[2.5rem] p-6 flex flex-col gap-4 items-center border-2">
                    </div>

                    <div id="factorize-action-area" class="w-full">
                        <button onclick="performFactorize()" class="btn-bubble btn-eq w-full h-14 rounded-full text-xl font-semibold shadow-lg">ÿ™ÿ¨ÿ≤€åŸá ⁄©ŸÜ</button>
                    </div>
                    
                    <div id="factorize-result" class="glass-panel min-h-[6rem] rounded-[2rem] flex flex-col items-center justify-center p-4 text-center font-bold text-gray-700 dark:text-gray-200 border-2">
                        ŸÖŸÜÿ™ÿ∏ÿ± Ÿàÿ±ŸàÿØ€å...
                    </div>
                 </div>
            `;
            setFactorizeSubTab('algebraic');
        }

        /**
         * Sets factorize sub-tab
         */
        function setFactorizeSubTab(mode) {
            factorizeSubTab = mode;
            const buttons = ['algebraic', 'fraction'];
            buttons.forEach(btn => {
                const el = document.getElementById(`btn-fact-${btn}`);
                if (btn === mode) {
                    el.className = "flex-1 whitespace-nowrap px-3 py-2 rounded-full text-xs font-semibold bg-white/70 dark:bg-white/20 text-gray-900 dark:text-white shadow-sm transition-all";
                } else {
                    el.className = "flex-1 whitespace-nowrap px-3 py-2 rounded-full text-xs font-semibold text-gray-600 dark:text-gray-400 hover:bg-white/50 transition-all";
                }
            });

            const container = document.getElementById('factorize-inputs');
            const resultArea = document.getElementById('factorize-result');

            resultArea.innerText = 'ŸÖŸÜÿ™ÿ∏ÿ± Ÿàÿ±ŸàÿØ€å...';
            variablePowers = {};

            if (mode === 'algebraic') {
                container.innerHTML = `
                    <p class="text-sm text-gray-600 dark:text-gray-300 mb-2 text-center font-semibold">ÿπÿ®ÿßÿ±ÿ™ ÿ¨ÿ®ÿ±€å ÿ±ÿß Ÿàÿßÿ±ÿØ ⁄©ŸÜ€åÿØ</p>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mb-3 text-center">ŸÖÿ´ÿßŸÑ: xy+xy¬≤ €åÿß 2ab+3a</p>
                    
                    <input type="text" id="alg-expr" class="glass-input w-full h-14 rounded-xl text-center font-mono text-lg" placeholder="ŸÖÿ´ŸÑÿß: xy+xy¬≤" dir="ltr" oninput="detectVariables()">
                    
                    <div id="power-badges-container" class="w-full flex flex-wrap gap-2 justify-center min-h-[50px] items-center mt-2">
                        <p class="text-xs text-gray-400">ÿ™ŸàÿßŸÜ‚ÄåŸáÿß ÿß€åŸÜÿ¨ÿß ŸÜŸÖÿß€åÿ¥ ÿØÿßÿØŸá ŸÖ€å‚Äåÿ¥ŸàŸÜÿØ</p>
                    </div>
                `;

            } else if (mode === 'fraction') {
                container.innerHTML = `
                    <p class="text-sm text-gray-600 dark:text-gray-300 mb-3 text-center">ÿ™ÿ¨ÿ≤€åŸá ⁄©ÿ≥ÿ± ÿ¨ÿ®ÿ±€å (ÿµŸàÿ±ÿ™ Ÿà ŸÖÿÆÿ±ÿ¨ ÿ¨ÿØÿß⁄ØÿßŸÜŸá)</p>
                    
                    <div class="w-full flex flex-col gap-4">
                        <div class="glass-panel p-4 rounded-2xl">
                            <label class="text-xs text-gray-600 dark:text-gray-300 mb-2 block text-center font-bold">ÿµŸàÿ±ÿ™ ⁄©ÿ≥ÿ±</label>
                            <input type="text" id="frac-num-expr" class="glass-input w-full h-12 rounded-xl text-center font-mono" placeholder="ŸÖÿ´ŸÑÿß: x¬≤-4" dir="ltr" oninput="detectVariablesFraction('num')">
                            
                            <div id="power-badges-num" class="w-full flex flex-wrap gap-2 justify-center min-h-[40px] items-center mt-2">
                                <p class="text-xs text-gray-400">ÿ™ŸàÿßŸÜ‚ÄåŸáÿß€å ÿµŸàÿ±ÿ™</p>
                            </div>
                        </div>

                        <div class="w-full h-px bg-gray-400 my-1"></div>

                        <div class="glass-panel p-4 rounded-2xl">
                            <label class="text-xs text-gray-600 dark:text-gray-300 mb-2 block text-center font-bold">ŸÖÿÆÿ±ÿ¨ ⁄©ÿ≥ÿ±</label>
                            <input type="text" id="frac-den-expr" class="glass-input w-full h-12 rounded-xl text-center font-mono" placeholder="ŸÖÿ´ŸÑÿß: 2x+4" dir="ltr" oninput="detectVariablesFraction('den')">
                            
                            <div id="power-badges-den" class="w-full flex flex-wrap gap-2 justify-center min-h-[40px] items-center mt-2">
                                <p class="text-xs text-gray-400">ÿ™ŸàÿßŸÜ‚ÄåŸáÿß€å ŸÖÿÆÿ±ÿ¨</p>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        /**
         * Detects variables in algebraic expression and creates power inputs
         */
        function detectVariables() {
            const expr = document.getElementById('alg-expr').value;
            const container = document.getElementById('power-badges-container');
            
            // Extract variable occurrences with their context
            const varPattern = /([a-z])(\^?\d*)/gi;
            const matches = {};
            let match;
            
            while ((match = varPattern.exec(expr)) !== null) {
                const variable = match[1].toLowerCase();
                if (!matches[variable]) {
                    matches[variable] = [];
                }
                matches[variable].push(match.index);
            }
            
            if (Object.keys(matches).length === 0) {
                container.innerHTML = '<p class="text-xs text-gray-400">ÿ™ŸàÿßŸÜ‚ÄåŸáÿß ÿß€åŸÜÿ¨ÿß ŸÜŸÖÿß€åÿ¥ ÿØÿßÿØŸá ŸÖ€å‚Äåÿ¥ŸàŸÜÿØ</p>';
                variablePowers = {};
                return;
            }

            // Initialize powers for each occurrence
            for (const variable in matches) {
                if (!variablePowers[variable]) {
                    variablePowers[variable] = {};
                }
                matches[variable].forEach((pos, idx) => {
                    const key = `${variable}_${idx + 1}`;
                    if (!variablePowers[variable][key]) {
                        variablePowers[variable][key] = 1;
                    }
                });
                
                // Clean up old occurrences
                for (const key in variablePowers[variable]) {
                    const occIdx = parseInt(key.split('_')[1]);
                    if (occIdx > matches[variable].length) {
                        delete variablePowers[variable][key];
                    }
                }
            }

            // Remove variables that no longer exist
            for (const v in variablePowers) {
                if (!matches[v]) {
                    delete variablePowers[v];
                }
            }

            // Render power badges
            let html = '';
            for (const variable in variablePowers) {
                for (const occKey in variablePowers[variable]) {
                    const [varName, occNum] = occKey.split('_');
                    const displayLabel = Object.keys(variablePowers[variable]).length > 1 ? 
                        `${varName} (${occNum === '1' ? 'ÿßŸàŸÑ' : occNum === '2' ? 'ÿØŸàŸÖ' : 'ÿ≥ŸàŸÖ'})` : 
                        varName;
                    
                    html += `
                        <div class="power-badge">
                            <span class="font-mono">${displayLabel}</span>
                            <span class="text-xs">ÿ™ŸàÿßŸÜ:</span>
                            <input type="number" class="power-input" value="${variablePowers[variable][occKey]}" min="0" 
                                   onchange="updatePower('${variable}', '${occKey}', this.value)" onclick="event.stopPropagation()">
                            <button class="remove-power-btn" onclick="removePower('${variable}', '${occKey}')">√ó</button>
                        </div>
                    `;
                }
            }
            
            container.innerHTML = html || '<p class="text-xs text-gray-400">ÿ™ŸàÿßŸÜ‚ÄåŸáÿß ÿß€åŸÜÿ¨ÿß ŸÜŸÖÿß€åÿ¥ ÿØÿßÿØŸá ŸÖ€å‚Äåÿ¥ŸàŸÜÿØ</p>';
        }

        /**
         * Detects variables for fraction mode
         */
        function detectVariablesFraction(type) {
            const inputId = type === 'num' ? 'frac-num-expr' : 'frac-den-expr';
            const containerId = type === 'num' ? 'power-badges-num' : 'power-badges-den';
            
            const expr = document.getElementById(inputId).value;
            const container = document.getElementById(containerId);
            
            const varPattern = /([a-z])(\^?\d*)/gi;
            const matches = {};
            let match;
            
            while ((match = varPattern.exec(expr)) !== null) {
                const variable = match[1].toLowerCase();
                if (!matches[variable]) {
                    matches[variable] = [];
                }
                matches[variable].push(match.index);
            }
            
            const storageKey = type === 'num' ? 'numPowers' : 'denPowers';
            
            if (!variablePowers[storageKey]) {
                variablePowers[storageKey] = {};
            }
            
            if (Object.keys(matches).length === 0) {
                container.innerHTML = `<p class="text-xs text-gray-400">ÿ™ŸàÿßŸÜ‚ÄåŸáÿß€å ${type === 'num' ? 'ÿµŸàÿ±ÿ™' : 'ŸÖÿÆÿ±ÿ¨'}</p>`;
                variablePowers[storageKey] = {};
                return;
            }

            // Initialize powers for each occurrence
            for (const variable in matches) {
                if (!variablePowers[storageKey][variable]) {
                    variablePowers[storageKey][variable] = {};
                }
                matches[variable].forEach((pos, idx) => {
                    const key = `${variable}_${idx + 1}`;
                    if (!variablePowers[storageKey][variable][key]) {
                        variablePowers[storageKey][variable][key] = 1;
                    }
                });
                
                // Clean up old occurrences
                for (const key in variablePowers[storageKey][variable]) {
                    const occIdx = parseInt(key.split('_')[1]);
                    if (occIdx > matches[variable].length) {
                        delete variablePowers[storageKey][variable][key];
                    }
                }
            }

            // Remove variables that no longer exist
            for (const v in variablePowers[storageKey]) {
                if (!matches[v]) {
                    delete variablePowers[storageKey][v];
                }
            }

            // Render
            let html = '';
            for (const variable in variablePowers[storageKey]) {
                for (const occKey in variablePowers[storageKey][variable]) {
                    const [varName, occNum] = occKey.split('_');
                    const displayLabel = Object.keys(variablePowers[storageKey][variable]).length > 1 ? 
                        `${varName} (${occNum === '1' ? 'ÿßŸàŸÑ' : occNum === '2' ? 'ÿØŸàŸÖ' : 'ÿ≥ŸàŸÖ'})` : 
                        varName;
                    
                    html += `
                        <div class="power-badge">
                            <span class="font-mono">${displayLabel}</span>
                            <span class="text-xs">ÿ™ŸàÿßŸÜ:</span>
                            <input type="number" class="power-input" value="${variablePowers[storageKey][variable][occKey]}" min="0" 
                                   onchange="updatePowerFraction('${type}', '${variable}', '${occKey}', this.value)" onclick="event.stopPropagation()">
                            <button class="remove-power-btn" onclick="removePowerFraction('${type}', '${variable}', '${occKey}')">√ó</button>
                        </div>
                    `;
                }
            }
            
            container.innerHTML = html || `<p class="text-xs text-gray-400">ÿ™ŸàÿßŸÜ‚ÄåŸáÿß€å ${type === 'num' ? 'ÿµŸàÿ±ÿ™' : 'ŸÖÿÆÿ±ÿ¨'}</p>`;
        }

        /**
         * Updates power for a variable occurrence
         */
        function updatePower(variable, occKey, value) {
            variablePowers[variable][occKey] = parseInt(value) || 1;
        }

        /**
         * Updates power for fraction mode
         */
        function updatePowerFraction(type, variable, occKey, value) {
            const storageKey = type === 'num' ? 'numPowers' : 'denPowers';
            variablePowers[storageKey][variable][occKey] = parseInt(value) || 1;
        }

        /**
         * Removes a power badge
         */
        function removePower(variable, occKey) {
            delete variablePowers[variable][occKey];
            
            if (Object.keys(variablePowers[variable]).length === 0) {
                delete variablePowers[variable];
            }
            
            detectVariables();
        }

        /**
         * Removes power badge in fraction mode
         */
        function removePowerFraction(type, variable, occKey) {
            const storageKey = type === 'num' ? 'numPowers' : 'denPowers';
            delete variablePowers[storageKey][variable][occKey];
            
            if (Object.keys(variablePowers[storageKey][variable]).length === 0) {
                delete variablePowers[storageKey][variable];
            }
            
            detectVariablesFraction(type);
        }

        /**
         * Performs factorization based on current mode
         */
        function performFactorize() {
            const resDiv = document.getElementById('factorize-result');

            if (factorizeSubTab === 'algebraic') {
                const exprInput = document.getElementById('alg-expr');
                if (!exprInput) return;
                
                const expr = exprInput.value.trim();
                
                if (!expr) {
                    resDiv.innerHTML = '<span class="text-red-600">ŸÑÿ∑ŸÅÿßŸã ÿπÿ®ÿßÿ±ÿ™ ÿ±ÿß Ÿàÿßÿ±ÿØ ⁄©ŸÜ€åÿØ</span>';
                    return;
                }

                try {
                    const result = factorizeExpressionWithPowers(expr, variablePowers);
                    resDiv.innerHTML = `<div class="factorization-display">${result}</div>`;
                } catch (e) {
                    resDiv.innerHTML = '<span class="text-red-600">ÿÆÿ∑ÿß ÿØÿ± ÿ™ÿ¨ÿ≤€åŸá ÿπÿ®ÿßÿ±ÿ™</span>';
                }

            } else if (factorizeSubTab === 'fraction') {
                const numExpr = document.getElementById('frac-num-expr').value.trim();
                const denExpr = document.getElementById('frac-den-expr').value.trim();

                if (!numExpr || !denExpr) {
                    resDiv.innerHTML = '<span class="text-red-600">ŸÑÿ∑ŸÅÿßŸã ÿµŸàÿ±ÿ™ Ÿà ŸÖÿÆÿ±ÿ¨ ÿ±ÿß Ÿàÿßÿ±ÿØ ⁄©ŸÜ€åÿØ</span>';
                    return;
                }

                try {
                    const numPowers = variablePowers.numPowers || {};
                    const denPowers = variablePowers.denPowers || {};
                    
                    const numFactored = factorizeExpressionWithPowers(numExpr, numPowers);
                    const denFactored = factorizeExpressionWithPowers(denExpr, denPowers);

                    // Find common factors to cancel
                    const numFactors = extractFactors(numFactored);
                    const denFactors = extractFactors(denFactored);
                    const commonFactors = findCommonFactors(numFactors, denFactors);

                    if (commonFactors.length > 0) {
                        const canceledHTML = commonFactors.map(f => `<span style="text-decoration: line-through; color: #dc2626;">${f}</span>`).join('');
                        resDiv.innerHTML = `
                            <div class="flex flex-col items-center gap-3 w-full">
                                <div class="text-xs text-gray-600 dark:text-gray-400">ÿπŸàÿßŸÖŸÑ ŸÖÿ¥ÿ™ÿ±⁄©: ${canceledHTML}</div>
                                <div class="flex flex-col items-center">
                                    <span class="text-lg font-mono text-gray-900 dark:text-white px-4 factorization-display" dir="ltr">${removeCommonFactors(numFactored, commonFactors)}</span>
                                    <div class="w-full h-0.5 bg-gray-600 rounded-full my-2"></div>
                                    <span class="text-lg font-mono text-gray-900 dark:text-white px-4 factorization-display" dir="ltr">${removeCommonFactors(denFactored, commonFactors)}</span>
                                </div>
                            </div>
                        `;
                    } else {
                        resDiv.innerHTML = `
                            <div class="flex flex-col items-center gap-3 w-full">
                                <div class="flex flex-col items-center">
                                    <span class="text-lg font-mono text-gray-900 dark:text-white px-4 factorization-display" dir="ltr">${numFactored}</span>
                                    <div class="w-full h-0.5 bg-gray-600 rounded-full my-2"></div>
                                    <span class="text-lg font-mono text-gray-900 dark:text-white px-4 factorization-display" dir="ltr">${denFactored}</span>
                                </div>
                            </div>
                        `;
                    }
                } catch (e) {
                    resDiv.innerHTML = '<span class="text-red-600">ÿÆÿ∑ÿß ÿØÿ± ÿ™ÿ¨ÿ≤€åŸá ⁄©ÿ≥ÿ±</span>';
                }
            }
        }

        /**
         * Extracts individual factors from factored expression
         */
        function extractFactors(factoredExpr) {
            const factors = [];
            const parts = factoredExpr.split('(');
            
            if (parts.length > 1) {
                // Extract coefficient
                const coeff = parts[0].match(/[\d]+/);
                if (coeff) factors.push(coeff[0]);
                
                // Extract variables with powers
                const vars = parts[0].match(/[a-z](\^\d+)?/gi);
                if (vars) factors.push(...vars);
                
                // Extract terms in parentheses
                for (let i = 1; i < parts.length; i++) {
                    const content = parts[i].split(')')[0];
                    if (content) factors.push(`(${content})`);
                }
            }
            
            return factors;
        }

        /**
         * Finds common factors between numerator and denominator
         */
        function findCommonFactors(numFactors, denFactors) {
            const common = [];
            const denCopy = [...denFactors];
            
            for (const factor of numFactors) {
                const idx = denCopy.indexOf(factor);
                if (idx !== -1) {
                    common.push(factor);
                    denCopy.splice(idx, 1);
                }
            }
            
            return common;
        }

        /**
         * Removes common factors from expression
         */
        function removeCommonFactors(expr, commonFactors) {
            let result = expr;
            
            for (const factor of commonFactors) {
                result = result.replace(factor, '').replace(/^\*/, '').replace(/\*$/, '');
            }
            
            // Clean up empty results
            result = result.replace(/\(\s*\)/, '').trim();
            if (!result || result === '*') result = '1';
            
            return result;
        }

        /**
         * Factorizes expression using user-specified powers
         */
        function factorizeExpressionWithPowers(expr, powers) {
            try {
                // Clean expression
                expr = expr.replace(/\s+/g, '');
                expr = expr.replace(/([0-9])([a-z])/gi, '$1*$2');
                
                // Build power map for all occurrences
                const powerMap = {};
                for (const variable in powers) {
                    if (typeof powers[variable] === 'object') {
                        // Multiple occurrences
                        for (const occKey in powers[variable]) {
                            powerMap[occKey] = powers[variable][occKey];
                        }
                    }
                }
                
                // Apply powers to each occurrence
                let modifiedExpr = expr;
                let varIndex = {};
                
                const varPattern = /([a-z])/gi;
                let newExpr = '';
                let lastIndex = 0;
                let match;
                
                while ((match = varPattern.exec(expr)) !== null) {
                    const variable = match[1].toLowerCase();
                    
                    if (!varIndex[variable]) {
                        varIndex[variable] = 1;
                    } else {
                        varIndex[variable]++;
                    }
                    
                    const occKey = `${variable}_${varIndex[variable]}`;
                    const power = powerMap[occKey] || 1;
                    
                    newExpr += expr.substring(lastIndex, match.index) + variable;
                    if (power > 1) {
                        newExpr += `^${power}`;
                    }
                    lastIndex = match.index + 1;
                }
                newExpr += expr.substring(lastIndex);
                
                expr = newExpr;
                
                const terms = parseExpression(expr);
                
                if (terms.length === 0) return expr;
                if (terms.length === 1) return expr;

                // Find GCD of coefficients
                const coefficients = terms.map(t => Math.abs(t.coefficient)).filter(c => c !== 0);
                if (coefficients.length === 0) return '0';
                
                let gcdCoeff = coefficients[0];
                for (let i = 1; i < coefficients.length; i++) {
                    gcdCoeff = gcd(gcdCoeff, coefficients[i]);
                }

                // Find common variables with minimum powers
                const commonVars = {};
                
                if (terms.length > 0) {
                    const firstTermVars = terms[0].variables;
                    
                    for (const variable in firstTermVars) {
                        let minPower = firstTermVars[variable];
                        let presentInAll = true;
                        
                        for (let i = 1; i < terms.length; i++) {
                            if (!terms[i].variables[variable]) {
                                presentInAll = false;
                                break;
                            }
                            minPower = Math.min(minPower, terms[i].variables[variable]);
                        }
                        
                        if (presentInAll && minPower > 0) {
                            commonVars[variable] = minPower;
                        }
                    }
                }

                // Check if factorization is possible
                if (gcdCoeff === 1 && Object.keys(commonVars).length === 0) {
                    return expr;
                }

                // Build factored part
                let factorPart = '';
                
                if (gcdCoeff > 1) {
                    factorPart += gcdCoeff;
                }

                const sortedVars = Object.keys(commonVars).sort();
                for (const variable of sortedVars) {
                    const power = commonVars[variable];
                    factorPart += variable;
                    if (power > 1) {
                        factorPart += '^' + power;
                    }
                }

                // Divide each term by common factor
                const reducedTerms = terms.map(t => {
                    let newCoeff = t.coefficient / gcdCoeff;
                    let newVars = {...t.variables};
                    
                    for (const variable in commonVars) {
                        if (newVars[variable]) {
                            newVars[variable] -= commonVars[variable];
                            if (newVars[variable] === 0) {
                                delete newVars[variable];
                            }
                        }
                    }
                    
                    return { coefficient: newCoeff, variables: newVars };
                });

                const insidePart = termsToString(reducedTerms);
                
                if (factorPart && insidePart !== '0') {
                    return factorPart + '(' + insidePart + ')';
                } else if (insidePart === '0') {
                    return '0';
                } else {
                    return expr;
                }

            } catch (e) {
                console.error('Factorization error:', e);
                return expr;
            }
        }

        /**
         * Parses expression into terms
         */
        function parseExpression(expr) {
            const terms = [];
            
            let currentTerm = '';
            let depth = 0;
            
            for (let i = 0; i < expr.length; i++) {
                const ch = expr[i];
                
                if (ch === '(') depth++;
                if (ch === ')') depth--;
                
                if ((ch === '+' || ch === '-') && depth === 0 && i > 0) {
                    terms.push(parseTerm(currentTerm));
                    currentTerm = ch === '-' ? '-' : '';
                } else {
                    currentTerm += ch;
                }
            }
            
            if (currentTerm) {
                terms.push(parseTerm(currentTerm));
            }
            
            return terms;
        }

        /**
         * Parses a single term
         */
        function parseTerm(term) {
            let coefficient = 1;
            const variables = {};
            
            const match = term.match(/^([+-]?\d*\.?\d*)/);
            if (match && match[1]) {
                if (match[1] === '+' || match[1] === '') {
                    coefficient = 1;
                } else if (match[1] === '-') {
                    coefficient = -1;
                } else {
                    coefficient = parseFloat(match[1]);
                }
                term = term.substring(match[1].length);
            }
            
            const varPattern = /([a-z])(\^?(\d+))?/gi;
            let varMatch;
            
            while ((varMatch = varPattern.exec(term)) !== null) {
                const variable = varMatch[1].toLowerCase();
                let power = 1;
                
                if (varMatch[3]) {
                    power = parseInt(varMatch[3]);
                }
                
                variables[variable] = (variables[variable] || 0) + power;
            }
            
            return { coefficient, variables };
        }

        /**
         * Converts terms to string
         */
        function termsToString(terms) {
            if (terms.length === 0) return '0';
            
            let result = '';
            
            for (let i = 0; i < terms.length; i++) {
                const t = terms[i];
                
                if (i === 0) {
                    if (t.coefficient < 0) {
                        result += '-';
                    }
                } else {
                    if (t.coefficient >= 0) {
                        result += ' + ';
                    } else {
                        result += ' - ';
                    }
                }
                
                const absCoeff = Math.abs(t.coefficient);
                const hasVars = Object.keys(t.variables).length > 0;
                
                if (absCoeff !== 1 || !hasVars) {
                    if (Number.isInteger(absCoeff)) {
                        result += absCoeff;
                    } else {
                        result += absCoeff.toFixed(2);
                    }
                }
                
                const sortedVars = Object.keys(t.variables).sort();
                for (const variable of sortedVars) {
                    result += variable;
                    if (t.variables[variable] > 1) {
                        result += '^' + t.variables[variable];
                    }
                }
            }
            
            return result || '0';
        }

        /**
         * Gets prime factorization
         */
        function getPrimeFactorization(n) {
            let num = n;
            let factors = {};
            let i = 2;
            while (i * i <= num) {
                while (num % i === 0) {
                    factors[i] = (factors[i] || 0) + 1;
                    num /= i;
                }
                i++;
            }
            if (num > 1) {
                factors[num] = (factors[num] || 0) + 1;
            }
            return factors;
        }

        /* ========================================
           EQUATION SOLVER
           ======================================== */
        
        /**
         * Renders equation solver UI
         */
        function renderEquation() {
            document.getElementById('app-content').innerHTML = `
                 <div class="flex flex-col gap-4 pt-2">
                    <div class="glass-panel p-1.5 rounded-full flex gap-1 overflow-x-auto border-2">
                         <button onclick="setEqMode('lin')" id="btn-lin" class="flex-1 whitespace-nowrap px-3 py-2 rounded-full text-xs font-semibold bg-white/70 text-gray-900 shadow-sm transition-all">ÿÆÿ∑€å</button>
                         <button onclick="setEqMode('frac')" id="btn-frac" class="flex-1 whitespace-nowrap px-3 py-2 rounded-full text-xs font-semibold text-gray-600 dark:text-gray-300 hover:bg-white/50 transition-all">⁄©ÿ≥ÿ±€å</button>
                         <button onclick="setEqMode('table')" id="btn-table" class="flex-1 whitespace-nowrap px-3 py-2 rounded-full text-xs font-semibold text-gray-600 dark:text-gray-300 hover:bg-white/50 transition-all">ÿ¨ÿØŸàŸÑ</button>
                    </div>

                    <div id="eq-inputs" class="glass-panel rounded-[2.5rem] p-6 flex flex-col gap-4 items-center border-2">
                    </div>

                    <div id="eq-action-area" class="w-full">
                        <button onclick="solveEq()" class="btn-bubble btn-eq w-full h-14 rounded-full text-xl font-semibold shadow-lg">ÿ≠ŸÑ ŸÖÿπÿßÿØŸÑŸá</button>
                    </div>
                    
                    <div id="eq-result" class="glass-panel min-h-[4rem] rounded-[2rem] flex flex-col items-center justify-center p-4 text-center font-bold text-gray-700 dark:text-gray-200 border-2">
                        ŸÖŸÜÿ™ÿ∏ÿ± Ÿàÿ±ŸàÿØ€å...
                    </div>
                 </div>
            `;
            setEqMode('lin');
        }

        let eqMode = 'lin';
        
        /**
         * Sets equation mode
         */
        function setEqMode(mode) {
            eqMode = mode;
            const buttons = ['lin', 'frac', 'table'];
            buttons.forEach(btn => {
                const el = document.getElementById(`btn-${btn}`);
                if (btn === mode) {
                    el.className = "flex-1 whitespace-nowrap px-3 py-2 rounded-full text-xs font-semibold bg-white/70 dark:bg-white/20 text-gray-900 dark:text-white shadow-sm transition-all";
                } else {
                    el.className = "flex-1 whitespace-nowrap px-3 py-2 rounded-full text-xs font-semibold text-gray-600 dark:text-gray-400 hover:bg-white/50 transition-all";
                }
            });

            const container = document.getElementById('eq-inputs');
            const actionArea = document.getElementById('eq-action-area');
            const resultArea = document.getElementById('eq-result');

            resultArea.innerText = 'ŸÖŸÜÿ™ÿ∏ÿ± Ÿàÿ±ŸàÿØ€å...';
            actionArea.innerHTML = `<button onclick="solveEq()" class="btn-bubble btn-eq w-full h-14 rounded-full text-xl font-semibold shadow-lg">ÿ≠ŸÑ ŸÖÿπÿßÿØŸÑŸá</button>`;

            if (mode === 'lin') {
                container.innerHTML = `
                    <div class="flex items-center gap-2 text-lg font-semibold text-gray-600 dark:text-gray-300" dir="ltr">
                        <input id="lin-a" type="number" class="glass-input w-14 h-12 rounded-xl text-center" placeholder="a">
                        <span>x +</span>
                        <input id="lin-b" type="number" class="glass-input w-14 h-12 rounded-xl text-center" placeholder="b">
                        <span>=</span>
                        <input id="lin-c" type="number" class="glass-input w-14 h-12 rounded-xl text-center" placeholder="c">
                    </div>
                    <p class="text-xs text-gray-500 font-sans">ŸÅÿ±ŸÖÿ™: ax + b = c</p>
                `;
            } else if (mode === 'frac') {
                container.innerHTML = `
                    <div class="flex items-center gap-2 text-lg font-semibold text-gray-600 dark:text-gray-300" dir="ltr">
                        <div class="flex flex-col items-center">
                            <div class="flex items-center gap-1">
                                <input id="f-a" type="number" class="glass-input w-10 h-10 rounded-xl text-center" placeholder="a">
                                <span>x +</span>
                                <input id="f-b" type="number" class="glass-input w-10 h-10 rounded-xl text-center" placeholder="b">
                            </div>
                            <div class="w-full h-px bg-gray-500/50 my-1"></div>
                            <div class="flex items-center gap-1">
                                <input id="f-c" type="number" class="glass-input w-10 h-10 rounded-xl text-center" placeholder="c">
                                <span>x +</span>
                                <input id="f-d" type="number" class="glass-input w-10 h-10 rounded-xl text-center" placeholder="d">
                            </div>
                        </div>
                        <span>=</span>
                        <input id="f-e" type="number" class="glass-input w-14 h-12 rounded-xl text-center" placeholder="e">
                    </div>
                    <p class="text-xs text-gray-500 font-sans">ŸÅÿ±ŸÖÿ™: (ax + b) / (cx + d) = e</p>
                `;
            } else if (mode === 'table') {
                container.innerHTML = `
                    <div class="w-full flex flex-col gap-4">
                        <div class="flex flex-col items-center w-full">
                            <label class="text-sm text-gray-600 dark:text-gray-300 font-bold mb-2">ÿπÿ®ÿßÿ±ÿ™ ÿ™ÿßÿ®ÿπ (y ÿ®ÿ± ÿ≠ÿ≥ÿ® x)</label>
                            <div class="flex items-center gap-2 w-full justify-center" dir="ltr">
                                <span class="font-mono text-xl text-gray-700 dark:text-gray-300 font-bold">y =</span>
                                <input id="tbl-eq" type="text" class="glass-input w-2/3 h-12 rounded-xl text-center font-mono text-lg" placeholder="ŸÖÿ´ŸÑÿß: 2*x + 1">
                            </div>
                        </div>

                        <div class="glass-panel w-full rounded-2xl p-2">
                            <div class="grid grid-cols-2 gap-2 mb-2 text-center border-b border-gray-400/30 pb-2">
                                <div class="font-mono font-bold text-gray-700 dark:text-gray-200 text-lg">x</div><div class="font-mono font-bold text-gray-700 dark:text-gray-200 text-lg">y</div>
                            </div>
                            <div class="flex flex-col gap-2" id="table-rows">
                                ${[0, 1, 2, 3].map(i => `
                                    <div class="grid grid-cols-2 gap-2">
                                        <input type="number" id="tbl-x-${i}" class="glass-input w-full h-10 rounded-lg text-center font-mono" placeholder="x">
                                        <input type="number" id="tbl-y-${i}" class="glass-input w-full h-10 rounded-lg text-center font-mono" placeholder="y">
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
                actionArea.innerHTML = `<button onclick="solveTableEquation()" class="btn-bubble btn-eq w-full h-14 rounded-full text-xl font-semibold shadow-lg">ÿ™⁄©ŸÖ€åŸÑ ÿ¨ÿØŸàŸÑ</button>`;
                resultArea.innerText = 'ŸÖŸÇÿßÿØ€åÿ± ÿÆÿßŸÑ€å ÿ±ÿß Ÿæÿ± ⁄©ŸÜ€åÿØ';
            }
        }

        /**
         * Solves table equation
         */
        function solveTableEquation() {
            const eqInput = document.getElementById('tbl-eq').value.trim();
            if (!eqInput) {
                document.getElementById('eq-result').innerHTML = '<span class="text-red-600">ŸÑÿ∑ŸÅÿßŸã ŸÖÿπÿßÿØŸÑŸá ÿ±ÿß Ÿàÿßÿ±ÿØ ⁄©ŸÜ€åÿØ</span>';
                return;
            }

            let parsedEq = eqInput.replace(/(\d)([a-zA-Z(])/g, '$1*$2');
            parsedEq = parsedEq.replace(/(\))([a-zA-Z0-9])/g, '$1*$2');

            const evaluateFunc = (xVal) => {
                try {
                    const func = new Function('x', `return ${parsedEq};`);
                    return func(xVal);
                } catch (e) {
                    return NaN;
                }
            };

            const solveForX = (yTarget) => {
                let x0 = -10, x1 = 10;
                let iter = 0;
                while (iter < 50) {
                    let y0 = evaluateFunc(x0) - yTarget;
                    let y1 = evaluateFunc(x1) - yTarget;
                    if (Math.abs(y1) < 0.0001) return x1;
                    if (Math.abs(y1 - y0) < 0.0000001) break; 

                    let xNew = x1 - y1 * (x1 - x0) / (y1 - y0);
                    x0 = x1;
                    x1 = xNew;
                    iter++;
                }
                return x1;
            };

            let filledCount = 0;
            let errorOccurred = false;

            for (let i = 0; i < 4; i++) {
                const xEl = document.getElementById(`tbl-x-${i}`);
                const yEl = document.getElementById(`tbl-y-${i}`);

                const xValStr = xEl.value;
                const yValStr = yEl.value;

                if (xValStr !== '' && yValStr === '') {
                    const xVal = parseFloat(xValStr);
                    const yVal = evaluateFunc(xVal);
                    if (!isNaN(yVal)) {
                        yEl.value = parseFloat(yVal.toFixed(4));
                        yEl.classList.add('bg-green-100/50');
                        filledCount++;
                    } else {
                        errorOccurred = true;
                    }
                } else if (yValStr !== '' && xValStr === '') {
                    const yVal = parseFloat(yValStr);
                    const xVal = solveForX(yVal);
                    if (!isNaN(xVal) && Math.abs(evaluateFunc(xVal) - yVal) < 0.1) {
                         xEl.value = parseFloat(xVal.toFixed(4));
                         xEl.classList.add('bg-green-100/50'); 
                         filledCount++;
                    }
                }
            }

            if (errorOccurred) {
                document.getElementById('eq-result').innerHTML = '<span class="text-red-600">ÿÆÿ∑ÿß ÿØÿ± ŸÖÿ≠ÿßÿ≥ÿ®Ÿá ŸÖÿπÿßÿØŸÑŸá</span>';
            } else if (filledCount > 0) {
                document.getElementById('eq-result').innerHTML = '<span class="text-green-700">ÿ¨ÿØŸàŸÑ ÿ™⁄©ŸÖ€åŸÑ ÿ¥ÿØ</span>';
            } else {
                document.getElementById('eq-result').innerText = 'ÿ™ÿ∫€å€åÿ±€å ÿß€åÿ¨ÿßÿØ ŸÜÿ¥ÿØ';
            }
        }

        /**
         * Solves equation
         */
        function solveEq() {
            const resDiv = document.getElementById('eq-result');
            if (eqMode === 'lin') {
                const a = parseFloat(document.getElementById('lin-a').value);
                const b = parseFloat(document.getElementById('lin-b').value);
                const c = parseFloat(document.getElementById('lin-c').value);
                if(isNaN(a) || isNaN(b) || isNaN(c)) { resDiv.innerHTML = '<span class="text-red-600">Ÿàÿ±ŸàÿØ€å ŸÜÿßŸÇÿµ</span>'; return;}
                if(a === 0) { resDiv.innerHTML = '<span class="text-red-700">a ŸÜÿ®ÿß€åÿØ ÿµŸÅÿ± ÿ®ÿßÿ¥ÿØ</span>'; return; }
                const x = (c - b) / a;

                const stepHTML = `
                    <div id="steps-container" class="hidden text-right text-sm text-gray-600 dark:text-gray-300 mt-2 bg-white/20 p-2 rounded-xl w-full">
                        <div class="mb-1 font-bold">ŸÖÿ±ÿßÿ≠ŸÑ ÿ≠ŸÑ:</div>
                        <div>1. ÿßÿ®ÿ™ÿØÿß ÿπÿØÿØ ÿ´ÿßÿ®ÿ™ (${b}) ÿ±ÿß ÿ®Ÿá ÿ≥ŸÖÿ™ ÿ±ÿßÿ≥ÿ™ ŸÖŸÜÿ™ŸÇŸÑ ŸÖ€å‚Äå⁄©ŸÜ€åŸÖ:</div>
                        <div class="font-mono text-center my-1" dir="ltr">${a}x = ${c} - ${b}</div>
                        <div class="font-mono text-center my-1" dir="ltr">${a}x = ${c - b}</div>
                        <div>2. ÿ≥Ÿæÿ≥ ÿ∑ÿ±ŸÅ€åŸÜ ÿ±ÿß ÿ®ÿ± ÿ∂ÿ±€åÿ® x (${a}) ÿ™ŸÇÿ≥€åŸÖ ŸÖ€å‚Äå⁄©ŸÜ€åŸÖ:</div>
                        <div class="font-mono text-center my-1" dir="ltr">x = ${c - b} / ${a}</div>
                        <div class="font-mono text-center my-1 font-bold" dir="ltr">x = ${parseFloat(x.toFixed(4))}</div>
                    </div>
                `;

                resDiv.innerHTML = `
                    <div class="flex flex-col items-center gap-2 w-full">
                        <span class="text-2xl font-mono text-gray-900 dark:text-white">x = ${parseFloat(x.toFixed(4))}</span>
                        <button onclick="toggleLinearSteps()" class="text-xs bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 px-3 py-1 rounded-full hover:bg-blue-200 transition-colors">ŸÜŸÖÿß€åÿ¥ ÿ±ÿßŸá ÿ≠ŸÑ</button>
                        ${stepHTML}
                    </div>
                `;
            } else if (eqMode === 'frac') {
                const a = parseFloat(document.getElementById('f-a').value);
                const b = parseFloat(document.getElementById('f-b').value);
                const c = parseFloat(document.getElementById('f-c').value);
                const d = parseFloat(document.getElementById('f-d').value);
                const e = parseFloat(document.getElementById('f-e').value);

                if(isNaN(a) || isNaN(b) || isNaN(c) || isNaN(d) || isNaN(e)) { 
                    resDiv.innerHTML = '<span class="text-red-600">Ÿàÿ±ŸàÿØ€å ŸÜÿßŸÇÿµ</span>'; 
                    return;
                }

                const denominator = a - e * c;
                const numerator = e * d - b;

                if (denominator === 0) {
                    if (numerator === 0) {
                        resDiv.innerHTML = '<span class="text-orange-700">ÿ™ÿπÿØÿßÿØ ŸÜÿßŸÖÿ≠ÿØŸàÿØ ÿ¨Ÿàÿßÿ® ÿØÿßÿ±ÿØ</span>';
                    } else {
                        resDiv.innerHTML = '<span class="text-red-700">ŸÅÿßŸÇÿØ ÿ¨Ÿàÿßÿ® ÿßÿ≥ÿ™</span>';
                    }
                } else {
                    const x = numerator / denominator;
                    if (c * x + d === 0) {
                        resDiv.innerHTML = '<span class="text-red-700">ÿ¨Ÿàÿßÿ® ŸÇÿßÿ®ŸÑ ŸÇÿ®ŸàŸÑ ŸÜ€åÿ≥ÿ™ (ŸÖÿÆÿ±ÿ¨ ⁄©ÿ≥ÿ± ÿßŸàŸÑ€åŸá ÿµŸÅÿ± ŸÖ€å‚Äåÿ¥ŸàÿØ)</span>';
                    } else {
                        resDiv.innerHTML = `<span class="text-2xl font-mono text-gray-900 dark:text-white">x = ${x.toFixed(4)}</span>`;
                    }
                }
            }
        }

        /**
         * Toggles linear steps
         */
        function toggleLinearSteps() {
            const el = document.getElementById('steps-container');
            if (el && el.classList.contains('hidden')) {
                el.classList.remove('hidden');
            } else if (el) {
                el.classList.add('hidden');
            }
        }

        /* ========================================
           PROPERTIES SECTION
           ======================================== */
        
        /**
         * Renders properties
         */
        function renderProperties() {
            document.getElementById('app-content').innerHTML = `
                <div class="flex flex-col gap-4 pt-2">
                    <div class="glass-panel p-1.5 rounded-full flex gap-1 border-2">
                        <button onclick="setPropertiesSubTab('number')" id="btn-prop-number" class="flex-1 py-2 rounded-full text-xs font-semibold bg-white/70 text-gray-900 shadow-sm transition-all">ÿÆŸàÿßÿµ ÿπÿØÿØ</button>
                        <button onclick="setPropertiesSubTab('polygon')" id="btn-prop-polygon" class="flex-1 py-2 rounded-full text-xs font-semibold text-gray-600 dark:text-gray-300 hover:bg-white/50 transition-all">⁄ÜŸÜÿØÿ∂ŸÑÿπ€å</button>
                    </div>

                    <div id="properties-content"></div>
                </div>
            `;
            setPropertiesSubTab('number');
        }

        /**
         * Sets properties sub-tab
         */
        function setPropertiesSubTab(subTab){
            propertiesSubTab = subTab;
            
            const numBtn = document.getElementById('btn-prop-number');
            const polyBtn = document.getElementById('btn-prop-polygon');
            
            if (subTab === 'number') {
                numBtn.className = "flex-1 py-2 rounded-full text-xs font-semibold bg-white/70 dark:bg-white/20 text-gray-900 dark:text-white shadow-sm transition-all";
                polyBtn.className = "flex-1 py-2 rounded-full text-xs font-semibold text-gray-600 dark:text-gray-400 hover:bg-white/50 transition-all";
                renderNumberProperties();
            } else {
                polyBtn.className = "flex-1 py-2 rounded-full text-xs font-semibold bg-white/70 dark:bg-white/20 text-gray-900 dark:text-white shadow-sm transition-all";
                numBtn.className = "flex-1 py-2 rounded-full text-xs font-semibold text-gray-600 dark:text-gray-400 hover:bg-white/50 transition-all";
                renderPolygonProperties();
            }
        }

        /**
         * Renders number properties
         */
        function renderNumberProperties() {
            document.getElementById('properties-content').innerHTML = `
                <div class="flex flex-col gap-6 items-center">
                    <h3 class="text-gray-700 dark:text-gray-300 font-semibold text-lg opacity-80">ÿ®ÿ±ÿ±ÿ≥€å ÿßŸàŸÑ/ŸÖÿ±⁄©ÿ® ÿ®ŸàÿØŸÜ Ÿà ÿÆŸàÿßÿµ</h3>
                    <div class="glass-panel w-full p-8 rounded-[3rem] flex flex-col items-center border-2">
                        <label class="text-gray-600 dark:text-gray-300 font-semibold mb-3">ÿπÿØÿØ ÿµÿ≠€åÿ≠ Ÿà ŸÖÿ´ÿ®ÿ™ ÿ±ÿß Ÿàÿßÿ±ÿØ ⁄©ŸÜ€åÿØ (ÿ≠ÿØÿß⁄©ÿ´ÿ± 1000)</label>
                        <input id="num-input" type="number" min="1" step="1" max="1000" class="glass-input w-full h-16 text-3xl text-center rounded-2xl font-mono text-gray-800 placeholder-gray-400" placeholder="17">
                    </div>

                    <button onclick="checkPrime()" class="btn-bubble btn-eq h-14 rounded-full text-xl font-semibold shadow-lg">ÿ®ÿ±ÿ±ÿ≥€å ÿÆŸàÿßÿµ</button>

                    <div id="num-result" class="glass-panel w-full min-h-[12rem] rounded-[2rem] flex flex-col items-center p-4 gap-2 border-2">
                        <span class="text-center text-gray-500 dark:text-gray-300 text-sm">ŸÜÿ™€åÿ¨Ÿá ÿß€åŸÜÿ¨ÿß ŸÜŸÖÿß€åÿ¥ ÿØÿßÿØŸá ŸÖ€å‚Äåÿ¥ŸàÿØ</span>
                    </div>
                </div>
            `;
        }

        /**
         * Checks prime
         */
        function checkPrime() {
            const val = document.getElementById('num-input').value;
            const num = parseInt(val);
            const box = document.getElementById('num-result');

            if (isNaN(num) || num <= 0 || !Number.isInteger(num)) {
                box.innerHTML = '<span class="text-center text-red-600 font-bold">ŸÑÿ∑ŸÅÿßŸã €å⁄© ÿπÿØÿØ ÿµÿ≠€åÿ≠ ŸÖÿ´ÿ®ÿ™ Ÿàÿßÿ±ÿØ ⁄©ŸÜ€åÿØ.</span>';
                return;
            }
            if (num > 1000) {
                box.innerHTML = '<span class="text-center text-red-600 font-bold">ÿ®ÿ±ÿß€å ÿπŸÖŸÑ⁄©ÿ±ÿØ ÿ®Ÿáÿ™ÿ±ÿå ÿπÿØÿØ ÿ≠ÿØÿß⁄©ÿ´ÿ± 1000 ÿ®ÿßÿ¥ÿØ.</span>';
                return;
            }

            let resultHtml = '';
            let divisors = [];
            let primeDivisors = [];

            for (let i = 1; i <= num; i++) {
                if (num % i === 0) {
                    divisors.push(i);
                    if (i > 1) {
                        let isPrimeDivisor = true;
                        for(let j = 2; j <= Math.sqrt(i); j++) {
                            if (i % j === 0) {
                                isPrimeDivisor = false;
                                break;
                            }
                        }
                        if(isPrimeDivisor) primeDivisors.push(i);
                    }
                }
            }

            let primeStatus = '';
            if (num === 1) {
                primeStatus = '<span class="text-2xl text-orange-700 font-bold">ÿπÿØÿØ €±: ŸÜŸá ÿßŸàŸÑ ÿßÿ≥ÿ™ Ÿà ŸÜŸá ŸÖÿ±⁄©ÿ®.</span>';
            } else if (divisors.length === 2) {
                primeStatus = `<span class="text-2xl text-green-700 dark:text-green-400 font-bold">ÿπÿØÿØ ${num}: ÿßŸàŸÑ ÿßÿ≥ÿ™.</span>`;
            } else {
                primeStatus = `<span class="text-2xl text-blue-700 dark:text-blue-400 font-bold">ÿπÿØÿØ ${num}: ŸÖÿ±⁄©ÿ® ÿßÿ≥ÿ™.</span>`;
            }

            const factors = getPrimeFactorization(num);
            let factorizationStr = '';
            for (const [base, exp] of Object.entries(factors)) {
                if (exp === 1) {
                    factorizationStr += `${base} √ó `;
                } else {
                    factorizationStr += `${base}<sup>${exp}</sup> √ó `;
                }
            }
            factorizationStr = factorizationStr.slice(0, -3) || `${num} (ŸÅÿß⁄©ÿ™Ÿàÿ±⁄Ø€åÿ±€å ŸÑÿßÿ≤ŸÖ ŸÜ€åÿ≥ÿ™)`;

            resultHtml = `
                ${primeStatus}
                <div class="mt-4 w-full text-base font-sans" dir="rtl">
                    <p class="font-semibold text-gray-700 dark:text-gray-300 mb-2">ŸÖŸÇÿ≥ŸàŸÖ‚ÄåÿπŸÑ€åŸá‚ÄåŸáÿß (ÿßÿπÿØÿßÿØ ÿ®ÿÆÿ¥‚ÄåŸæÿ∞€åÿ±):</p>
                    <div class="p-2 bg-white/50 dark:bg-white/10 rounded-xl text-sm break-words">
                        <span class="font-mono text-gray-900 dark:text-white">${divisors.join(', ')}</span>
                    </div>

                    <p class="font-semibold text-gray-700 dark:text-gray-300 mt-4 mb-2">ÿ™ÿ¨ÿ≤€åŸá ÿ®Ÿá ÿπŸàÿßŸÖŸÑ ÿßŸàŸÑ:</p>
                    <div class="p-2 bg-white/50 dark:bg-white/10 rounded-xl text-sm break-words">
                        <span class="font-mono text-gray-900 dark:text-white">${factorizationStr}</span>
                    </div>
                </div>
            `;

            box.innerHTML = resultHtml;
        }

        /**
         * Renders polygon properties
         */
        function renderPolygonProperties() {
            document.getElementById('properties-content').innerHTML = `
                <div class="flex flex-col gap-6 items-center">
                    <h3 class="text-gray-700 dark:text-gray-300 font-semibold text-lg opacity-80">ÿÆŸàÿßÿµ ⁄ÜŸÜÿØÿ∂ŸÑÿπ€å ŸÖŸÜÿ™ÿ∏ŸÖ</h3>
                    <div class="glass-panel w-full p-8 rounded-[3rem] flex flex-col items-center border-2">
                        <label class="text-gray-600 dark:text-gray-300 font-semibold mb-3">ÿ™ÿπÿØÿßÿØ ÿßÿ∂ŸÑÿßÿπ (n ‚â• 3)</label>
                        <input id="poly-input" type="number" min="3" step="1" class="glass-input w-full h-16 text-3xl text-center rounded-2xl font-mono text-gray-800 placeholder-gray-400" placeholder="6">
                    </div>

                    <button onclick="calcPolygonProperties()" class="btn-bubble btn-eq h-14 rounded-full text-xl font-semibold shadow-lg">ŸÖÿ≠ÿßÿ≥ÿ®Ÿá ÿÆŸàÿßÿµ</button>

                    <div id="poly-result" class="glass-panel w-full min-h-[15rem] rounded-[2.5rem] flex flex-col justify-center px-4 py-6 gap-3 border-2">
                         <span class="text-center text-gray-500 dark:text-gray-300 text-sm">ŸÜÿ™ÿß€åÿ¨ ÿß€åŸÜÿ¨ÿß ŸÜŸÖÿß€åÿ¥ ÿØÿßÿØŸá ŸÖ€å‚Äåÿ¥ŸàÿØ</span>
                    </div>
                </div>
            `;
        }

        /**
         * Calculates polygon properties
         */
        function calcPolygonProperties() {
            const val = document.getElementById('poly-input').value;
            const n = parseInt(val);
            const box = document.getElementById('poly-result');

            if (isNaN(n) || n < 3 || !Number.isInteger(n)) {
                box.innerHTML = '<span class="text-center text-red-600 font-bold">ŸÑÿ∑ŸÅÿßŸã ÿ™ÿπÿØÿßÿØ ÿßÿ∂ŸÑÿßÿπ ÿ±ÿß €å⁄© ÿπÿØÿØ ÿµÿ≠€åÿ≠ ÿ®ÿ≤ÿ±⁄Øÿ™ÿ± €åÿß ŸÖÿ≥ÿßŸà€å €≥ Ÿàÿßÿ±ÿØ ⁄©ŸÜ€åÿØ.</span>';
                return;
            }

            const hasCenter = n % 2 === 0 ? 'ÿ®ŸÑŸáÿå ÿØÿßÿ±ÿØ (ŸÅŸÇÿ∑ ÿ®ÿ±ÿß€å n ÿ≤Ÿàÿ¨)' : 'ÿÆ€åÿ±ÿå ŸÜÿØÿßÿ±ÿØ';
            const axesCount = n;
            const sumInt = (n - 2) * 180;
            const eachInt = sumInt / n;
            const sumExt = 360;
            const eachExt = 360 / n;

            box.innerHTML = `
                <div class="text-center mb-4">
                    <span class="text-2xl font-bold text-gray-800 dark:text-white">${n}-ÿ∂ŸÑÿπ€å ŸÖŸÜÿ™ÿ∏ŸÖ</span>
                </div>
                <div class="result-grid">
                    <div class="result-item">
                        <span class="text-xs text-gray-600 dark:text-gray-300">ŸÖÿ±⁄©ÿ≤ ÿ™ŸÇÿßÿ±ŸÜ:</span>
                        <span class="text-lg font-bold ${n % 2 === 0 ? 'text-green-700 dark:text-green-400' : 'text-red-700 dark:text-red-400'}">${hasCenter}</span>
                    </div>
                    <div class="result-item">
                        <span class="text-xs text-gray-600 dark:text-gray-300">ŸÖÿ≠Ÿàÿ±Ÿáÿß€å ÿ™ŸÇÿßÿ±ŸÜ:</span>
                        <span class="text-2xl font-mono font-bold text-gray-900 dark:text-white">${axesCount}</span>
                    </div>
                    <div class="result-item">
                        <span class="text-xs text-gray-600 dark:text-gray-300">ŸÖÿ¨ŸÖŸàÿπ ÿ≤Ÿàÿß€åÿß ÿØÿßÿÆŸÑ€å:</span>
                        <span class="text-xl font-mono font-bold text-gray-900 dark:text-white">${sumInt}¬∞</span>
                    </div>
                    <div class="result-item">
                        <span class="text-xs text-gray-600 dark:text-gray-300">Ÿáÿ± ÿ≤ÿßŸà€åŸá ÿØÿßÿÆŸÑ€å:</span>
                        <span class="text-xl font-mono font-bold text-gray-900 dark:text-white">${eachInt.toFixed(2)}¬∞</span>
                    </div>
                    <div class="result-item">
                        <span class="text-xs text-gray-600 dark:text-gray-300">ŸÖÿ¨ŸÖŸàÿπ ÿ≤Ÿàÿß€åÿß ÿÆÿßÿ±ÿ¨€å:</span>
                        <span class="text-xl font-mono font-bold text-gray-900 dark:text-white">${sumExt}¬∞</span>
                    </div>
                    <div class="result-item">
                        <span class="text-xs text-gray-600 dark:text-gray-300">Ÿáÿ± ÿ≤ÿßŸà€åŸá ÿÆÿßÿ±ÿ¨€å:</span>
                        <span class="text-xl font-mono font-bold text-gray-900 dark:text-white">${eachExt.toFixed(2)}¬∞</span>
                    </div>
                </div>
            `;
        }

        /* ========================================
           SIEVE OF ERATOSTHENES
           ======================================== */
        
        /**
         * Renders sieve
         */
        function renderSieve() {
            document.getElementById('app-content').innerHTML = `
                <div class="flex flex-col gap-6 pt-6 items-center">
                    <h3 class="text-gray-700 dark:text-gray-300 font-semibold text-lg opacity-80">ÿ∫ÿ±ÿ®ÿßŸÑ⁄Øÿ±€å ÿßÿπÿØÿßÿØ ÿßŸàŸÑ (Sieve) üî¢</h3>
                    
                    <div class="glass-panel w-full p-6 rounded-[3rem] flex flex-col items-center border-2">
                        <p class="text-sm text-gray-600 dark:text-gray-300 mb-4 text-center font-semibold">ŸÖÿ≠ÿØŸàÿØŸá ÿßÿπÿØÿßÿØ ÿ±ÿß Ÿàÿßÿ±ÿØ ⁄©ŸÜ€åÿØ (ÿ≠ÿØÿß⁄©ÿ´ÿ± €±€∞,€∞€∞€∞):</p>
                        
                        <div class="flex gap-4 w-full justify-center">
                            <div class="flex flex-col items-center w-full">
                                <label for="sieve-start" class="text-xs text-gray-500 mb-1">ÿßÿ≤ ÿπÿØÿØ</label>
                                <input id="sieve-start" type="number" min="1" max="10000" step="1" class="glass-input w-full h-12 text-xl text-center rounded-xl font-mono text-gray-800" placeholder="1">
                            </div>
                            
                            <div class="flex flex-col items-center w-full">
                                <label for="sieve-end" class="text-xs text-gray-500 mb-1">ÿ™ÿß ÿπÿØÿØ</label>
                                <input id="sieve-end" type="number" min="1" max="10000" step="1" class="glass-input w-full h-12 text-xl text-center rounded-xl font-mono text-gray-800" placeholder="100">
                            </div>
                        </div>
                    </div>

                    <button onclick="calcSieve()" class="btn-bubble btn-eq h-14 rounded-full text-xl font-semibold shadow-lg">ÿ¥ÿ±Ÿàÿπ ÿ∫ÿ±ÿ®ÿßŸÑ⁄Øÿ±€å</button>

                    <div id="sieve-result" class="glass-panel w-full min-h-[6rem] rounded-[2.5rem] flex flex-col p-4 gap-4 border-2">
                         <span class="text-center text-gray-500 dark:text-gray-300 text-sm mt-4">ŸÜÿ™€åÿ¨Ÿá ÿß€åŸÜÿ¨ÿß ŸÜŸÖÿß€åÿ¥ ÿØÿßÿØŸá ŸÖ€å‚Äåÿ¥ŸàÿØ</span>
                    </div>
                </div>
            `;
        }

        /**
         * Calculates sieve of Eratosthenes
         */
        function calcSieve() {
            const startVal = parseInt(document.getElementById('sieve-start').value);
            const endVal = parseInt(document.getElementById('sieve-end').value);
            const box = document.getElementById('sieve-result');

            if (isNaN(startVal) || isNaN(endVal)) {
                box.innerHTML = '<span class="text-center text-red-600 font-bold mt-4">ŸÑÿ∑ŸÅÿßŸã ŸÖÿ≠ÿØŸàÿØŸá ÿ±ÿß ⁄©ÿßŸÖŸÑ Ÿàÿßÿ±ÿØ ⁄©ŸÜ€åÿØ.</span>';
                return;
            }
            if (startVal > endVal) {
                box.innerHTML = '<span class="text-center text-red-600 font-bold mt-4">ÿπÿØÿØ ÿ¥ÿ±Ÿàÿπ ÿ®ÿß€åÿØ ⁄©Ÿà⁄Ü⁄©ÿ™ÿ± ÿßÿ≤ Ÿæÿß€åÿßŸÜ ÿ®ÿßÿ¥ÿØ.</span>';
                return;
            }
            if (endVal > 10000) {
                box.innerHTML = '<span class="text-center text-red-600 font-bold mt-4">ÿ≠ÿØÿß⁄©ÿ´ÿ± ÿπÿØÿØ ŸÖÿ¨ÿßÿ≤ €±€∞,€∞€∞€∞ ÿßÿ≥ÿ™.</span>';
                return;
            }
            if (startVal < 1) {
                box.innerHTML = '<span class="text-center text-red-600 font-bold mt-4">ÿßÿπÿØÿßÿØ ÿ®ÿß€åÿØ ŸÖÿ´ÿ®ÿ™ ÿ®ÿßÿ¥ŸÜÿØ.</span>';
                return;
            }

            const isPrime = new Array(endVal + 1).fill(true);
            isPrime[0] = false;
            isPrime[1] = false;

            for (let i = 2; i * i <= endVal; i++) {
                if (isPrime[i]) {
                    for (let j = i * i; j <= endVal; j += i) {
                        isPrime[j] = false;
                    }
                }
            }

            const primes = [];
            const composites = [];

            for (let i = startVal; i <= endVal; i++) {
                if (isPrime[i]) {
                    primes.push(i);
                } else if (i > 1) {
                    composites.push(i);
                }
            }

            const primeCount = primes.length;
            const compositeCount = composites.length;

            box.innerHTML = `
                <div class="flex flex-col gap-4">
                    <div class="flex flex-col gap-2">
                        <div class="flex justify-between items-center border-b border-green-500/30 pb-1">
                            <span class="text-green-700 dark:text-green-400 font-bold">ÿßÿπÿØÿßÿØ ÿßŸàŸÑ (${primeCount})</span>
                        </div>
                        <div class="text-sm font-mono text-gray-800 dark:text-gray-200 leading-relaxed break-words bg-green-50/50 dark:bg-green-900/20 p-3 rounded-xl">
                            ${primes.length > 0 ? primes.join(', ') : 'ŸÖŸàÿ±ÿØ€å €åÿßŸÅÿ™ ŸÜÿ¥ÿØ'}
                        </div>
                    </div>

                    <div class="flex flex-col gap-2">
                        <div class="flex justify-between items-center border-b border-blue-500/30 pb-1">
                            <span class="text-blue-700 dark:text-blue-400 font-bold">ÿßÿπÿØÿßÿØ ŸÖÿ±⁄©ÿ® (${compositeCount})</span>
                        </div>
                        <div class="text-sm font-mono text-gray-800 dark:text-gray-200 leading-relaxed break-words bg-blue-50/50 dark:bg-blue-900/20 p-3 rounded-xl">
                            ${composites.length > 0 ? composites.join(', ') : 'ŸÖŸàÿ±ÿØ€å €åÿßŸÅÿ™ ŸÜÿ¥ÿØ'}
                        </div>
                    </div>
                </div>
            `;
        }

        /* ========================================
           METALS CALCULATOR
           ======================================== */
        
        /**
         * Renders metals calculator
         */
        function renderMetals() {
            let metalOptions = '';
            for (const [key, name] of Object.entries(metalNames)) {
                metalOptions += `<option value="${key}">${name}</option>`;
            }

            document.getElementById('app-content').innerHTML = `
                <div class="flex flex-col gap-4 pt-4">
                    <h3 class="text-gray-700 dark:text-gray-300 font-semibold text-lg text-center">ŸÖÿ≠ÿßÿ≥ÿ®Ÿá‚Äå⁄Øÿ± Ÿàÿ≤ŸÜ ŸÅŸÑÿ≤ÿßÿ™</h3>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">ŸÜŸàÿπ ŸÅŸÑÿ≤:</label>
                        <select id="metal-select" class="glass-input w-full h-12 rounded-xl text-center">
                            ${metalOptions}
                        </select>
                    </div>

                    <div class="glass-panel rounded-2xl p-4 border-2">
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-3 text-center">ÿßÿ®ÿπÿßÿØ (ÿ≥ÿßŸÜÿ™€å‚ÄåŸÖÿ™ÿ±)</label>
                        <div class="flex gap-3">
                            <div class="flex-1">
                                <input type="number" id="length" class="glass-input w-full h-12 rounded-xl text-center" placeholder="ÿ∑ŸàŸÑ" step="0.01">
                            </div>
                            <div class="flex-1">
                                <input type="number" id="width" class="glass-input w-full h-12 rounded-xl text-center" placeholder="ÿπÿ±ÿ∂" step="0.01">
                            </div>
                            <div class="flex-1">
                                <input type="number" id="height" class="glass-input w-full h-12 rounded-xl text-center" placeholder="ÿßÿ±ÿ™ŸÅÿßÿπ" step="0.01">
                            </div>
                        </div>
                    </div>

                    <button onclick="calculateMetalWeight()" class="btn-bubble btn-eq w-full h-14 rounded-xl font-bold text-lg shadow-lg">ŸÖÿ≠ÿßÿ≥ÿ®Ÿá Ÿàÿ≤ŸÜ</button>

                    <div id="metal-result" class="glass-panel rounded-2xl p-6 text-center min-h-[100px] flex items-center justify-center border-2">
                        <span class="text-gray-500 dark:text-gray-300">ŸÜÿ™€åÿ¨Ÿá ÿß€åŸÜÿ¨ÿß ŸÜŸÖÿß€åÿ¥ ÿØÿßÿØŸá ŸÖ€å‚Äåÿ¥ŸàÿØ</span>
                    </div>
                </div>
            `;
        }

        /**
         * Calculates metal weight
         */
        function calculateMetalWeight() {
            const metal = document.getElementById('metal-select').value;
            const length = parseFloat(document.getElementById('length').value);
            const width = parseFloat(document.getElementById('width').value);
            const height = parseFloat(document.getElementById('height').value);
            const resultDiv = document.getElementById('metal-result');

            if (isNaN(length) || isNaN(width) || isNaN(height) || length <= 0 || width <= 0 || height <= 0) {
                resultDiv.innerHTML = '<span class="text-red-600 font-bold">ŸÑÿ∑ŸÅÿßŸã ÿ™ŸÖÿßŸÖ ÿßÿ®ÿπÿßÿØ ÿ±ÿß ÿ®Ÿá ÿØÿ±ÿ≥ÿ™€å Ÿàÿßÿ±ÿØ ⁄©ŸÜ€åÿØ</span>';
                return;
            }

            const volume = length * width * height; // cm¬≥
            const density = metalDensities[metal];
            const weight = volume * density; // grams

            const weightKg = weight / 1000;

            resultDiv.innerHTML = `
                <div class="flex flex-col gap-3 w-full">
                    <div class="text-2xl font-bold text-green-700 dark:text-green-400">${metalNames[metal]}</div>
                    <div class="flex flex-col gap-2">
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600 dark:text-gray-300">ÿ≠ÿ¨ŸÖ:</span>
                            <span class="font-mono font-bold">${volume.toFixed(2)} cm¬≥</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600 dark:text-gray-300">⁄Ü⁄ØÿßŸÑ€å:</span>
                            <span class="font-mono font-bold">${density} g/cm¬≥</span>
                        </div>
                        <div class="h-px bg-gray-300 dark:bg-gray-600 my-2"></div>
                        <div class="flex justify-between items-center">
                            <span class="text-base font-bold text-gray-800 dark:text-white">Ÿàÿ≤ŸÜ:</span>
                            <span class="text-xl font-mono font-bold text-blue-700 dark:text-blue-400">${weight.toFixed(2)} ⁄Øÿ±ŸÖ</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600 dark:text-gray-300">ŸÖÿπÿßÿØŸÑ:</span>
                            <span class="font-mono font-bold">${weightKg.toFixed(4)} ⁄©€åŸÑŸà⁄Øÿ±ŸÖ</span>
                        </div>
                    </div>
                </div>
            `;
        }
    </script>
</body>
</html>
